# 第6章：完整專案實作 - 中級

建立在初級專案的基礎上，本章將帶您開發一個更複雜的「電商訂單追蹤自動化系統」。這個中級專案將涵蓋多步驟工作流程、條件邏輯、資料轉換以及多平台整合。

## 6.1 專案概述

### 🎯 專案目標

建立一個智能的電商訂單追蹤系統，當客戶下單時自動：
1. 驗證訂單資訊和庫存狀態
2. 根據訂單金額和客戶等級決定處理優先級
3. 自動分配到不同的處理團隊
4. 發送個人化的訂單確認郵件
5. 更新多個系統的庫存和財務記錄
6. 設定自動化的物流追蹤通知

### 📋 業務複雜度

**中級專案特色：**
- 多條件分支邏輯
- 資料轉換和運算
- 多系統整合
- 異常處理和回滾機制
- 客戶分群處理
- 動態內容生成

### 🏗️ 系統架構

```
電商訂單追蹤系統
├── 訂單接收層
│   ├── REST API 端點
│   ├── Webhook 接收器
│   └── 資料驗證模組
├── Make Bridge 核心邏輯
│   ├── 訂單驗證流程
│   ├── 客戶分級路由
│   ├── 庫存管理整合
│   ├── 財務系統同步
│   └── 通知發送引擎
├── 外部系統整合
│   ├── ERP 系統
│   ├── CRM 平台
│   ├── 物流 API
│   └── 金流服務
└── 監控和分析
    ├── 訂單狀態追蹤
    ├── 效能監控
    └── 異常警報
```

## 6.2 步驟 1：設計複雜的 Make Bridge 模板

### 🔄 完整工作流程設計

**📝 基於原文檔頁17-21：**設計包含多個分支和條件的複雜模板。

#### 主流程結構

```
1. [Webhook] 訂單接收
    ↓
2. [Data Transformer] 資料標準化
    ↓
3. [Router] 訂單類型分類
    ├── 一般訂單 → 4a
    ├── VIP 訂單 → 4b  
    └── 批量訂單 → 4c
    ↓
4a. [HTTP] 庫存檢查 → 5a
4b. [HTTP] VIP 快速處理 → 5b
4c. [HTTP] 批量驗證 → 5c
    ↓
5a-c. [Aggregator] 合併處理結果
    ↓
6. [Router] 庫存狀態路由
    ├── 有庫存 → 7a
    └── 缺貨 → 7b
    ↓
7a. [HTTP] 建立出貨單 → 8a
7b. [Email] 缺貨通知 → 8b
    ↓
8a. [Multi] 同步更新
    ├── Google Sheets (庫存)
    ├── Airtable (訂單)
    └── Slack (團隊通知)
    ↓
9. [Gmail] 客戶確認郵件
    ↓
10. [HTTP] 設定追蹤通知
```

### 🔧 關鍵模組詳細設定

#### 模組 1：Webhook 觸發器設定

```javascript
// 訂單資料結構定義
{
  "orderId": "ORD-2025-0001",
  "customer": {
    "id": "CUST-12345",
    "name": "王小明",
    "email": "customer@example.com",
    "tier": "VIP", // Standard, VIP, Premium
    "phone": "+886-912-345-678"
  },
  "items": [
    {
      "productId": "PROD-001",
      "productName": "無線藍牙耳機",
      "quantity": 2,
      "unitPrice": 2990,
      "totalPrice": 5980
    }
  ],
  "order": {
    "subtotal": 5980,
    "shipping": 150,
    "tax": 599,
    "total": 6729,
    "currency": "TWD",
    "paymentMethod": "credit_card",
    "shippingAddress": {
      "name": "王小明",
      "phone": "+886-912-345-678",
      "address": "台北市信義區信義路五段7號",
      "postalCode": "110"
    }
  },
  "metadata": {
    "source": "online_store",
    "timestamp": "2025-01-15T14:30:00Z",
    "ip": "1.2.3.4",
    "userAgent": "Mozilla/5.0..."
  }
}
```

**Webhook 欄位設定：**
```javascript
{
  "webhookName": {
    "showInTemplate": true,
    "label": "訂單接收 Webhook",
    "hint": "用於接收電商平台的訂單資料"
  },
  "expectedStructure": {
    "showInTemplate": false,
    "useValueInTemplate": true,
    "defaultValue": "上述 JSON 結構"
  }
}
```

#### 模組 2：資料轉換器設定

```javascript
// Data Transformer 設定
{
  "transformations": [
    {
      "field": "customerTierScore",
      "formula": "switch({{customer.tier}}, 'Standard', 1, 'VIP', 2, 'Premium', 3, 1)"
    },
    {
      "field": "priorityLevel", 
      "formula": "{{order.total}} > 10000 ? 'HIGH' : {{customerTierScore}} >= 2 ? 'MEDIUM' : 'NORMAL'"
    },
    {
      "field": "processingDeadline",
      "formula": "addDays(now(), {{priorityLevel}} == 'HIGH' ? 1 : {{priorityLevel}} == 'MEDIUM' ? 2 : 3)"
    },
    {
      "field": "orderCategory",
      "formula": "{{items.length}} > 5 ? 'BULK' : {{customer.tier}} == 'Premium' ? 'VIP' : 'STANDARD'"
    }
  ]
}
```

#### 模組 3：Router 條件分流設定

```javascript
// Router 設定
{
  "routes": [
    {
      "name": "VIP快速通道",
      "condition": "{{orderCategory}} == 'VIP' OR {{priorityLevel}} == 'HIGH'",
      "label": "VIP 或高價值訂單",
      "showInTemplate": true
    },
    {
      "name": "批量訂單處理",
      "condition": "{{orderCategory}} == 'BULK'",
      "label": "批量訂單（超過5項商品）",
      "showInTemplate": true
    },
    {
      "name": "一般訂單處理",
      "condition": "{{orderCategory}} == 'STANDARD'",
      "label": "標準訂單處理流程",
      "showInTemplate": true
    }
  ]
}
```

#### 模組 4：庫存檢查 HTTP 模組

```javascript
// HTTP 庫存檢查設定
{
  "url": {
    "showInTemplate": true,
    "label": "庫存系統 API URL",
    "hint": "ERP 系統的庫存查詢端點",
    "defaultValue": "https://erp.yourcompany.com/api/inventory/check"
  },
  "method": "POST",
  "headers": {
    "showInTemplate": true,
    "useValueInTemplate": true,
    "defaultValue": {
      "Content-Type": "application/json",
      "Authorization": "Bearer {{erp.apiKey}}"
    }
  },
  "body": {
    "allowMapping": true,
    "defaultValue": {
      "orderId": "{{orderId}}",
      "items": "{{items}}",
      "priorityLevel": "{{priorityLevel}}"
    }
  }
}
```

#### 模組 5：客戶通知郵件模組

```javascript
// Gmail 個人化郵件設定
{
  "to": "{{customer.email}}",
  "subject": {
    "showInTemplate": true,
    "useValueInTemplate": true,
    "defaultValue": "訂單確認 {{orderId}} - 感謝您的購買！",
    "label": "郵件主旨範本"
  },
  "content": {
    "showInTemplate": true,
    "useValueInTemplate": true,
    "label": "郵件內容範本",
    "defaultValue": `親愛的 {{customer.name}}，

感謝您在我們商店的購買！您的訂單已成功建立。

📋 訂單詳情
訂單編號：{{orderId}}
下單時間：{{formatDate(metadata.timestamp, 'YYYY-MM-DD HH:mm')}}
處理優先級：{{priorityLevel}}

🛍️ 商品清單
{{#each items}}
- {{productName}} × {{quantity}} = NT$ {{formatNumber(totalPrice)}}
{{/each}}

💰 金額摘要
商品小計：NT$ {{formatNumber(order.subtotal)}}
運費：NT$ {{formatNumber(order.shipping)}}
稅金：NT$ {{formatNumber(order.tax)}}
─────────────
總計：NT$ {{formatNumber(order.total)}}

📦 配送資訊
收件人：{{order.shippingAddress.name}}
電話：{{order.shippingAddress.phone}}
地址：{{order.shippingAddress.address}}

預計處理時間：{{processingDeadline}} 前完成出貨
{{#if customer.tier == 'VIP' OR customer.tier == 'Premium'}}
🌟 作為 {{customer.tier}} 會員，您的訂單享有優先處理！
{{/if}}

如有任何問題，請隨時聯繫我們的客服團隊。

祝您購物愉快！
客服團隊`
  }
}
```

### 📊 模板欄位使用者設定

**使用者需要設定的關鍵欄位：**

1. **系統整合設定**
   - ERP 系統 API 金鑰和端點
   - CRM 系統連接資訊
   - 物流 API 設定

2. **通知設定**
   - Gmail 連接
   - Slack 工作區和頻道
   - 緊急聯絡人清單

3. **業務規則自訂**
   - VIP 客戶標準
   - 優先處理金額門檻
   - 處理時間設定

4. **範本個人化**
   - 郵件範本內容
   - 公司品牌資訊
   - 客服聯絡資訊

## 6.3 步驟 2：建立進階前端管理介面

### 🎨 訂單管理儀表板

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電商訂單追蹤系統</title>
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard">
        <!-- 側邊導航 -->
        <nav class="sidebar">
            <div class="logo">
                <h2>📦 訂單系統</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="#dashboard" class="nav-link active"><i class="fas fa-chart-pie"></i> 儀表板</a></li>
                <li><a href="#orders" class="nav-link"><i class="fas fa-shopping-cart"></i> 訂單管理</a></li>
                <li><a href="#automation" class="nav-link"><i class="fas fa-robot"></i> 自動化設定</a></li>
                <li><a href="#settings" class="nav-link"><i class="fas fa-cog"></i> 系統設定</a></li>
            </ul>
        </nav>

        <!-- 主要內容區 -->
        <main class="main-content">
            <!-- 標題列 -->
            <header class="content-header">
                <h1 id="page-title">訂單追蹤儀表板</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="setupMakeBridge()">
                        <i class="fas fa-plus"></i> 設定自動化
                    </button>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="fas fa-sync"></i> 重新整理
                    </button>
                </div>
            </header>

            <!-- 儀表板內容 -->
            <div id="dashboard-section" class="content-section">
                <!-- 統計卡片 -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-orders">0</div>
                            <div class="stat-label">今日訂單</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-revenue">$0</div>
                            <div class="stat-label">今日營收</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="pending-orders">0</div>
                            <div class="stat-label">待處理</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="success-rate">0%</div>
                            <div class="stat-label">自動化成功率</div>
                        </div>
                    </div>
                </div>

                <!-- 最近訂單 -->
                <div class="content-card">
                    <div class="card-header">
                        <h3>最近訂單</h3>
                        <button class="btn btn-sm btn-outline" onclick="viewAllOrders()">
                            查看全部
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="data-table" id="recent-orders">
                                <thead>
                                    <tr>
                                        <th>訂單編號</th>
                                        <th>客戶</th>
                                        <th>金額</th>
                                        <th>優先級</th>
                                        <th>狀態</th>
                                        <th>時間</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 動態載入內容 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 自動化設定區 -->
            <div id="automation-section" class="content-section" style="display: none;">
                <div class="content-card">
                    <div class="card-header">
                        <h3>Make Bridge 自動化設定</h3>
                    </div>
                    <div class="card-body">
                        <div id="bridge-integration-container">
                            <!-- Make Bridge 整合精靈將載入在這裡 -->
                        </div>
                        
                        <!-- 設定步驟指引 -->
                        <div class="setup-guide">
                            <h4>設定步驟：</h4>
                            <ol>
                                <li>連接您的 ERP 系統</li>
                                <li>設定 Gmail 郵件服務</li>
                                <li>配置 Slack 通知</li>
                                <li>自訂業務規則</li>
                                <li>測試自動化流程</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Make Bridge 載入 -->
    <script src="https://portal-integrations.make.com/js/portal-integrations.js"></script>
    <script src="dashboard.js"></script>
</body>
</html>
```

### 🎨 進階 CSS 樣式

```css
/* dashboard.css - 管理儀表板樣式 */

:root {
    --primary-color: #2563eb;
    --secondary-color: #64748b;
    --success-color: #059669;
    --warning-color: #d97706;
    --error-color: #dc2626;
    --background-color: #f8fafc;
    --surface-color: #ffffff;
    --border-color: #e2e8f0;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --sidebar-width: 260px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: var(--background-color);
    color: var(--text-primary);
    line-height: 1.6;
}

/* 儀表板佈局 */
.dashboard {
    display: flex;
    min-height: 100vh;
}

/* 側邊欄 */
.sidebar {
    width: var(--sidebar-width);
    background: var(--surface-color);
    border-right: 1px solid var(--border-color);
    padding: 20px 0;
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
}

.logo {
    padding: 0 20px;
    margin-bottom: 30px;
}

.logo h2 {
    color: var(--primary-color);
    font-size: 1.5rem;
    font-weight: 700;
}

.nav-menu {
    list-style: none;
}

.nav-menu li {
    margin-bottom: 5px;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.2s;
}

.nav-link:hover,
.nav-link.active {
    background: #f1f5f9;
    color: var(--primary-color);
    border-right: 3px solid var(--primary-color);
}

.nav-link i {
    margin-right: 12px;
    width: 20px;
    text-align: center;
}

/* 主要內容區 */
.main-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

/* 內容標題 */
.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}

.content-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
}

.header-actions {
    display: flex;
    gap: 10px;
}

/* 按鈕樣式 */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
}

.btn-secondary {
    background: var(--surface-color);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: #f8fafc;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 13px;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

/* 統計卡片網格 */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

/* 統計卡片 */
.stat-card {
    background: var(--surface-color);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 16px;
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.stat-card:nth-child(1) .stat-icon {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.stat-card:nth-child(2) .stat-icon {
    background: linear-gradient(135deg, #059669, #047857);
    color: white;
}

.stat-card:nth-child(3) .stat-icon {
    background: linear-gradient(135deg, #d97706, #b45309);
    color: white;
}

.stat-card:nth-child(4) .stat-icon {
    background: linear-gradient(135deg, #7c3aed, #5b21b6);
    color: white;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-label {
    color: var(--text-secondary);
    font-size: 14px;
}

/* 內容卡片 */
.content-card {
    background: var(--surface-color);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-color);
}

.card-header h3 {
    font-size: 1.25rem;
    font-weight: 600;
}

.card-body {
    padding: 24px;
}

/* 表格樣式 */
.table-container {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    text-align: left;
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
}

.data-table th {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 14px;
    background: #f8fafc;
}

.data-table td {
    font-size: 14px;
}

/* 狀態標籤 */
.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
}

.status-processing {
    background: #fef3c7;
    color: #92400e;
}

.status-completed {
    background: #d1fae5;
    color: #065f46;
}

.status-error {
    background: #fee2e2;
    color: #991b1b;
}

/* 優先級標籤 */
.priority-high {
    background: #fee2e2;
    color: #991b1b;
}

.priority-medium {
    background: #fef3c7;
    color: #92400e;
}

.priority-normal {
    background: #e0e7ff;
    color: #3730a3;
}

/* 設定指引 */
.setup-guide {
    margin-top: 30px;
    padding: 20px;
    background: #f8fafc;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
}

.setup-guide h4 {
    margin-bottom: 15px;
    color: var(--text-primary);
}

.setup-guide ol {
    margin-left: 20px;
}

.setup-guide li {
    margin-bottom: 8px;
    color: var(--text-secondary);
}

/* Make Bridge 整合容器 */
#bridge-integration-container {
    min-height: 400px;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    background: #fafafa;
}

/* 響應式設計 */
@media (max-width: 1024px) {
    .sidebar {
        width: 200px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
}

@media (max-width: 768px) {
    .dashboard {
        flex-direction: column;
    }
    
    .sidebar {
        width: 100%;
        height: auto;
    }
    
    .nav-menu {
        display: flex;
        overflow-x: auto;
    }
    
    .nav-menu li {
        margin-bottom: 0;
        margin-right: 5px;
    }
    
    .content-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .header-actions {
        width: 100%;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
}

/* 動畫效果 */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.content-section {
    animation: fadeInUp 0.5s ease-out;
}

/* 載入狀態 */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
```

### ⚡ 進階 JavaScript 管理邏輯

```javascript
// dashboard.js - 儀表板管理邏輯

class OrderTrackingDashboard {
    constructor() {
        this.currentSection = 'dashboard';
        this.makeBridge = null;
        this.data = {
            orders: [],
            stats: {},
            automationStatus: 'inactive'
        };
        
        this.initializeApp();
    }

    async initializeApp() {
        this.setupNavigation();
        this.loadDashboardData();
        this.setupAutoRefresh();
        
        // 檢查是否已設定 Make Bridge
        await this.checkMakeBridgeStatus();
    }

    setupNavigation() {
        const navLinks = document.querySelectorAll('.nav-link');
        
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.getAttribute('href').substring(1);
                this.switchSection(section);
            });
        });
    }

    switchSection(sectionName) {
        // 隱藏所有區塊
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
        });
        
        // 顯示目標區塊
        const targetSection = document.getElementById(`${sectionName}-section`);
        if (targetSection) {
            targetSection.style.display = 'block';
        }
        
        // 更新導航狀態
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`[href="#${sectionName}"]`).classList.add('active');
        
        // 更新頁面標題
        const titles = {
            'dashboard': '訂單追蹤儀表板',
            'orders': '訂單管理',
            'automation': '自動化設定',
            'settings': '系統設定'
        };
        document.getElementById('page-title').textContent = titles[sectionName] || '訂單系統';
        
        this.currentSection = sectionName;
        
        // 載入區塊特定內容
        this.loadSectionData(sectionName);
    }

    async loadSectionData(sectionName) {
        switch (sectionName) {
            case 'dashboard':
                await this.loadDashboardData();
                break;
            case 'orders':
                await this.loadOrdersData();
                break;
            case 'automation':
                await this.loadAutomationData();
                break;
        }
    }

    async loadDashboardData() {
        try {
            this.showLoading();
            
            // 並行載入統計資料
            const [statsData, ordersData] = await Promise.all([
                this.fetchStats(),
                this.fetchRecentOrders()
            ]);
            
            this.data.stats = statsData;
            this.data.orders = ordersData;
            
            this.updateStatsDisplay();
            this.updateOrdersTable();
            
        } catch (error) {
            console.error('載入儀表板資料失敗:', error);
            this.showError('無法載入儀表板資料');
        } finally {
            this.hideLoading();
        }
    }

    async fetchStats() {
        const response = await fetch('/api/dashboard/stats');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    }

    async fetchRecentOrders() {
        const response = await fetch('/api/orders/recent?limit=10');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    }

    updateStatsDisplay() {
        const stats = this.data.stats;
        
        document.getElementById('total-orders').textContent = this.formatNumber(stats.totalOrders || 0);
        document.getElementById('total-revenue').textContent = this.formatCurrency(stats.totalRevenue || 0);
        document.getElementById('pending-orders').textContent = this.formatNumber(stats.pendingOrders || 0);
        document.getElementById('success-rate').textContent = this.formatPercentage(stats.automationSuccessRate || 0);
    }

    updateOrdersTable() {
        const tbody = document.querySelector('#recent-orders tbody');
        tbody.innerHTML = '';
        
        this.data.orders.forEach(order => {
            const row = this.createOrderRow(order);
            tbody.appendChild(row);
        });
    }

    createOrderRow(order) {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>
                <div class="order-id">
                    <strong>${order.orderId}</strong>
                </div>
            </td>
            <td>
                <div class="customer-info">
                    <div>${order.customer.name}</div>
                    <div class="text-secondary">${order.customer.email}</div>
                </div>
            </td>
            <td>
                <div class="amount">
                    ${this.formatCurrency(order.total)}
                </div>
            </td>
            <td>
                <span class="status-badge priority-${order.priorityLevel.toLowerCase()}">
                    ${order.priorityLevel}
                </span>
            </td>
            <td>
                <span class="status-badge status-${order.status.toLowerCase()}">
                    ${this.getStatusText(order.status)}
                </span>
            </td>
            <td>
                <div class="timestamp">
                    ${this.formatDateTime(order.createdAt)}
                </div>
            </td>
            <td>
                <div class="actions">
                    <button class="btn btn-sm btn-outline" onclick="viewOrderDetails('${order.orderId}')">
                        查看
                    </button>
                </div>
            </td>
        `;
        
        return row;
    }

    async checkMakeBridgeStatus() {
        try {
            const response = await fetch('/api/automation/status');
            const status = await response.json();
            
            this.data.automationStatus = status.isActive ? 'active' : 'inactive';
            
            if (status.isActive) {
                this.initializeMakeBridge();
            }
            
        } catch (error) {
            console.error('檢查自動化狀態失敗:', error);
        }
    }

    async setupMakeBridge() {
        this.switchSection('automation');
        
        if (!this.makeBridge) {
            await this.initializeMakeBridge();
        }
        
        // 啟動整合精靈
        try {
            const templateId = await this.getTemplateId();
            await this.makeBridge.startIntegration(templateId);
        } catch (error) {
            console.error('啟動 Make Bridge 失敗:', error);
            this.showError('無法啟動自動化設定');
        }
    }

    async initializeMakeBridge() {
        if (typeof window.PortalIntegrations === 'undefined') {
            throw new Error('Make Bridge 腳本未載入');
        }

        const config = {
            container: '#bridge-integration-container',
            userId: 'admin@company.com', // 實際部署時應該是動態的
            zoneUrl: 'https://eu2.make.com',
            onSuccess: this.handleMakeBridgeSuccess.bind(this),
            onError: this.handleMakeBridgeError.bind(this),
            onClose: this.handleMakeBridgeClose.bind(this)
        };

        this.makeBridge = new MakeBridgeIntegration(config);
        await this.makeBridge.initialize();
    }

    async getTemplateId() {
        const response = await fetch('/api/automation/template-id');
        const data = await response.json();
        return data.templateId;
    }

    handleMakeBridgeSuccess(result) {
        console.log('Make Bridge 設定成功:', result);
        this.data.automationStatus = 'active';
        this.showSuccess('自動化設定完成！系統將開始自動處理訂單。');
        
        // 重新載入儀表板資料
        this.loadDashboardData();
    }

    handleMakeBridgeError(error) {
        console.error('Make Bridge 設定失敗:', error);
        this.showError('自動化設定失敗，請檢查設定或聯繫技術支援。');
    }

    handleMakeBridgeClose() {
        console.log('Make Bridge 設定已關閉');
    }

    setupAutoRefresh() {
        // 每30秒自動更新儀表板
        setInterval(() => {
            if (this.currentSection === 'dashboard') {
                this.loadDashboardData();
            }
        }, 30000);
    }

    // 工具函數
    formatNumber(number) {
        return new Intl.NumberFormat('zh-TW').format(number);
    }

    formatCurrency(amount) {
        return new Intl.NumberFormat('zh-TW', {
            style: 'currency',
            currency: 'TWD'
        }).format(amount);
    }

    formatPercentage(value) {
        return `${Math.round(value * 100)}%`;
    }

    formatDateTime(timestamp) {
        return new Intl.DateTimeFormat('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        }).format(new Date(timestamp));
    }

    getStatusText(status) {
        const statusMap = {
            'processing': '處理中',
            'completed': '已完成',
            'error': '錯誤',
            'pending': '待處理'
        };
        return statusMap[status] || status;
    }

    showLoading() {
        // 實作載入狀態顯示
    }

    hideLoading() {
        // 實作載入狀態隱藏
    }

    showSuccess(message) {
        this.showNotification(message, 'success');
    }

    showError(message) {
        this.showNotification(message, 'error');
    }

    showNotification(message, type) {
        // 實作通知顯示邏輯
        console.log(`${type.toUpperCase()}: ${message}`);
    }
}

// Make Bridge 整合類別（來自第5章，這裡簡化版本）
class MakeBridgeIntegration {
    constructor(config) {
        this.config = config;
        this.isInitialized = false;
    }

    async initialize() {
        // 初始化 Make Bridge
        this.isInitialized = true;
    }

    async startIntegration(templateId) {
        const token = await this.getAuthToken();
        
        window.PortalIntegrations.init({
            token: token,
            templateId: templateId,
            container: this.config.container,
            onSuccess: this.config.onSuccess,
            onError: this.config.onError,
            onClose: this.config.onClose
        });
    }

    async getAuthToken() {
        const response = await fetch('/api/auth/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: this.config.userId })
        });
        
        const data = await response.json();
        return data.token;
    }
}

// 全域函數
function refreshData() {
    if (window.dashboard) {
        window.dashboard.loadSectionData(window.dashboard.currentSection);
    }
}

function viewOrderDetails(orderId) {
    // 實作訂單詳情查看
    console.log('查看訂單:', orderId);
}

function viewAllOrders() {
    if (window.dashboard) {
        window.dashboard.switchSection('orders');
    }
}

// 初始化應用
document.addEventListener('DOMContentLoaded', () => {
    window.dashboard = new OrderTrackingDashboard();
});
```

## 6.4 步驟 3：後端 API 服務進階實作

### 🔧 完整的 Express 伺服器

```javascript
// server.js - 電商訂單追蹤系統後端
const express = require('express');
const jwt = require('jsonwebtoken');
const crypto = require('crypto');
const cors = require('cors');
const rateLimit = require('express-rate-limit');
const helmet = require('helmet');
const winston = require('winston');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// 日誌設定
const logger = winston.createLogger({
    level: 'info',
    format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.json()
    ),
    transports: [
        new winston.transports.File({ filename: 'error.log', level: 'error' }),
        new winston.transports.File({ filename: 'combined.log' })
    ]
});

if (process.env.NODE_ENV !== 'production') {
    logger.add(new winston.transports.Console({
        format: winston.format.simple()
    }));
}

// 安全性中間件
app.use(helmet());
app.use(cors({
    origin: process.env.FRONTEND_URL || 'http://localhost:3000',
    credentials: true
}));

// 請求頻率限制
const apiLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 分鐘
    max: 100 // 最多 100 次請求
});
app.use('/api/', apiLimiter);

const orderLimiter = rateLimit({
    windowMs: 60 * 1000, // 1 分鐘
    max: 10 // 最多 10 次訂單處理
});
app.use('/api/orders/process', orderLimiter);

app.use(express.json({ limit: '10mb' }));
app.use(express.static('public'));

// Make Bridge 設定
const MAKE_CONFIG = {
    secret: process.env.MAKE_BRIDGE_SECRET,
    keyId: process.env.MAKE_BRIDGE_KEY_ID,
    zoneUrl: process.env.MAKE_ZONE_URL || 'https://eu2.make.com',
    templateId: process.env.ORDER_TRACKING_TEMPLATE_ID
};

/**
 * 訂單處理服務
 */
class OrderProcessingService {
    constructor(config) {
        this.config = config;
        this.authManager = new MakeBridgeAuthManager(config);
    }

    /**
     * 處理新訂單
     */
    async processOrder(orderData) {
        try {
            // 1. 驗證訂單資料
            const validation = this.validateOrderData(orderData);
            if (!validation.isValid) {
                throw new Error(`訂單驗證失敗: ${validation.errors.join(', ')}`);
            }

            // 2. 豐富訂單資料
            const enrichedOrder = await this.enrichOrderData(orderData);

            // 3. 提交到 Make Bridge
            const result = await this.submitToMakeBridge(enrichedOrder);

            // 4. 記錄處理結果
            logger.info('訂單處理成功', {
                orderId: orderData.orderId,
                customerId: orderData.customer.id,
                total: orderData.order.total,
                priority: enrichedOrder.priorityLevel
            });

            return {
                success: true,
                orderId: orderData.orderId,
                integrationId: result.integrationId,
                priority: enrichedOrder.priorityLevel,
                estimatedProcessingTime: enrichedOrder.processingDeadline
            };

        } catch (error) {
            logger.error('訂單處理失敗', {
                orderId: orderData.orderId,
                error: error.message
            });
            throw error;
        }
    }

    validateOrderData(data) {
        const errors = [];
        
        // 基本必填欄位檢查
        if (!data.orderId) errors.push('缺少訂單編號');
        if (!data.customer?.email) errors.push('缺少客戶 Email');
        if (!data.customer?.name) errors.push('缺少客戶姓名');
        if (!data.items?.length) errors.push('訂單項目不能為空');
        if (!data.order?.total) errors.push('缺少訂單總金額');

        // 商品項目檢查
        data.items?.forEach((item, index) => {
            if (!item.productId) errors.push(`商品 ${index + 1} 缺少產品 ID`);
            if (!item.quantity || item.quantity <= 0) errors.push(`商品 ${index + 1} 數量無效`);
            if (!item.unitPrice || item.unitPrice <= 0) errors.push(`商品 ${index + 1} 單價無效`);
        });

        // Email 格式檢查
        if (data.customer?.email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(data.customer.email)) {
                errors.push('客戶 Email 格式不正確');
            }
        }

        // 金額一致性檢查
        if (data.items?.length && data.order?.subtotal) {
            const calculatedSubtotal = data.items.reduce((sum, item) => sum + item.totalPrice, 0);
            if (Math.abs(calculatedSubtotal - data.order.subtotal) > 1) {
                errors.push('商品小計與實際計算不符');
            }
        }

        return {
            isValid: errors.length === 0,
            errors: errors
        };
    }

    async enrichOrderData(orderData) {
        const enriched = { ...orderData };

        // 計算客戶等級分數
        const tierScores = { 'Standard': 1, 'VIP': 2, 'Premium': 3 };
        enriched.customerTierScore = tierScores[orderData.customer.tier] || 1;

        // 計算優先級
        if (orderData.order.total > 10000) {
            enriched.priorityLevel = 'HIGH';
        } else if (enriched.customerTierScore >= 2) {
            enriched.priorityLevel = 'MEDIUM';
        } else {
            enriched.priorityLevel = 'NORMAL';
        }

        // 計算處理期限
        const processingDays = {
            'HIGH': 1,
            'MEDIUM': 2,
            'NORMAL': 3
        };
        const deadline = new Date();
        deadline.setDate(deadline.getDate() + processingDays[enriched.priorityLevel]);
        enriched.processingDeadline = deadline.toISOString();

        // 訂單分類
        if (orderData.items.length > 5) {
            enriched.orderCategory = 'BULK';
        } else if (orderData.customer.tier === 'Premium') {
            enriched.orderCategory = 'VIP';
        } else {
            enriched.orderCategory = 'STANDARD';
        }

        // 添加處理時間戳記
        enriched.processedAt = new Date().toISOString();

        return enriched;
    }

    async submitToMakeBridge(orderData) {
        const token = this.authManager.generateToken(orderData.customer.email);
        
        const url = `${this.config.zoneUrl}/portal/api/bridge/integrations/init/${this.config.templateId}`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                autoActivate: true,
                data: orderData
            })
        });

        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(`Make Bridge API 錯誤: ${response.status} - ${errorData}`);
        }

        return response.json();
    }
}

/**
 * 儀表板資料服務
 */
class DashboardService {
    async getStats() {
        // 模擬統計資料（實際應用應從資料庫獲取）
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        
        return {
            totalOrders: 42,
            totalRevenue: 128500,
            pendingOrders: 7,
            automationSuccessRate: 0.95,
            averageProcessingTime: 1.2, // 小時
            topProducts: [
                { name: '無線藍牙耳機', count: 15 },
                { name: '智能手錶', count: 12 },
                { name: '手機殼', count: 8 }
            ]
        };
    }

    async getRecentOrders(limit = 10) {
        // 模擬最近訂單資料
        const orders = [];
        for (let i = 1; i <= limit; i++) {
            orders.push({
                orderId: `ORD-2025-${String(i).padStart(4, '0')}`,
                customer: {
                    name: `客戶 ${i}`,
                    email: `customer${i}@example.com`,
                    tier: ['Standard', 'VIP', 'Premium'][i % 3]
                },
                total: Math.floor(Math.random() * 20000) + 1000,
                priorityLevel: ['NORMAL', 'MEDIUM', 'HIGH'][i % 3],
                status: ['processing', 'completed', 'pending'][i % 3],
                createdAt: new Date(Date.now() - i * 3600000).toISOString()
            });
        }
        return orders;
    }
}

// 初始化服務
const orderService = new OrderProcessingService(MAKE_CONFIG);
const dashboardService = new DashboardService();

/**
 * API 路由：處理新訂單
 */
app.post('/api/orders/process', async (req, res) => {
    try {
        const orderData = req.body;
        
        logger.info('接收新訂單', {
            orderId: orderData.orderId,
            customerId: orderData.customer?.id
        });

        const result = await orderService.processOrder(orderData);
        
        res.json(result);
        
    } catch (error) {
        logger.error('訂單處理 API 錯誤', {
            error: error.message,
            orderData: req.body
        });
        
        res.status(500).json({
            success: false,
            error: '訂單處理失敗',
            message: error.message
        });
    }
});

/**
 * API 路由：取得儀表板統計
 */
app.get('/api/dashboard/stats', async (req, res) => {
    try {
        const stats = await dashboardService.getStats();
        res.json(stats);
    } catch (error) {
        logger.error('取得統計資料失敗', { error: error.message });
        res.status(500).json({ error: '無法取得統計資料' });
    }
});

/**
 * API 路由：取得最近訂單
 */
app.get('/api/orders/recent', async (req, res) => {
    try {
        const limit = parseInt(req.query.limit) || 10;
        const orders = await dashboardService.getRecentOrders(limit);
        res.json(orders);
    } catch (error) {
        logger.error('取得訂單列表失敗', { error: error.message });
        res.status(500).json({ error: '無法取得訂單列表' });
    }
});

/**
 * API 路由：自動化狀態檢查
 */
app.get('/api/automation/status', async (req, res) => {
    try {
        const isActive = !!MAKE_CONFIG.templateId;
        res.json({
            isActive: isActive,
            templateId: MAKE_CONFIG.templateId,
            lastCheck: new Date().toISOString()
        });
    } catch (error) {
        res.status(500).json({ error: '無法檢查自動化狀態' });
    }
});

/**
 * API 路由：取得模板 ID
 */
app.get('/api/automation/template-id', (req, res) => {
    if (!MAKE_CONFIG.templateId) {
        return res.status(404).json({ error: '尚未設定模板 ID' });
    }
    
    res.json({ templateId: MAKE_CONFIG.templateId });
});

/**
 * API 路由：JWT Token 生成
 */
app.post('/api/auth/token', (req, res) => {
    try {
        const { userId } = req.body;
        
        if (!userId) {
            return res.status(400).json({ error: 'userId 參數是必要的' });
        }

        const authManager = new MakeBridgeAuthManager(MAKE_CONFIG);
        const token = authManager.generateToken(userId);
        
        res.json({
            token: token,
            expiresIn: 120,
            tokenType: 'Bearer'
        });
        
    } catch (error) {
        logger.error('Token 生成失敗', { error: error.message });
        res.status(500).json({ error: 'Token 生成失敗' });
    }
});

/**
 * 錯誤處理中間件
 */
app.use((error, req, res, next) => {
    logger.error('未處理的錯誤', {
        error: error.message,
        stack: error.stack,
        url: req.url,
        method: req.method
    });
    
    res.status(500).json({
        error: '內部伺服器錯誤',
        message: process.env.NODE_ENV === 'development' ? error.message : '請稍後再試'
    });
});

/**
 * JWT 認證管理器
 */
class MakeBridgeAuthManager {
    constructor(config) {
        this.secret = config.secret;
        this.keyId = config.keyId;
        
        if (!this.secret || !this.keyId) {
            throw new Error('Make Bridge 認證設定不完整');
        }
    }

    generateToken(userId) {
        return jwt.sign(
            {
                sub: userId,
                jti: crypto.randomUUID(),
            },
            this.secret,
            {
                expiresIn: '2m',
                keyid: this.keyId,
            }
        );
    }
}

/**
 * 啟動伺服器
 */
app.listen(PORT, () => {
    logger.info('電商訂單追蹤系統已啟動', {
        port: PORT,
        nodeEnv: process.env.NODE_ENV,
        makeZoneUrl: MAKE_CONFIG.zoneUrl,
        hasTemplateId: !!MAKE_CONFIG.templateId
    });
});

module.exports = app;
```

## 6.5 步驟 4：整合測試與優化

### 🧪 系統測試流程

#### 1. 單元測試

```javascript
// tests/order-processing.test.js
const { OrderProcessingService } = require('../server');

describe('OrderProcessingService', () => {
    let service;
    
    beforeEach(() => {
        service = new OrderProcessingService({
            secret: 'test_secret',
            keyId: 'test_key_id',
            zoneUrl: 'https://test.make.com',
            templateId: 'test_template_id'
        });
    });

    describe('validateOrderData', () => {
        test('應該驗證有效的訂單資料', () => {
            const validOrder = {
                orderId: 'ORD-TEST-001',
                customer: {
                    id: 'CUST-001',
                    name: '測試客戶',
                    email: 'test@example.com',
                    tier: 'VIP'
                },
                items: [{
                    productId: 'PROD-001',
                    quantity: 1,
                    unitPrice: 1000,
                    totalPrice: 1000
                }],
                order: {
                    subtotal: 1000,
                    total: 1100
                }
            };

            const result = service.validateOrderData(validOrder);
            expect(result.isValid).toBe(true);
            expect(result.errors).toHaveLength(0);
        });

        test('應該檢測無效的訂單資料', () => {
            const invalidOrder = {
                orderId: '',
                customer: {
                    email: 'invalid-email'
                },
                items: [],
                order: {}
            };

            const result = service.validateOrderData(invalidOrder);
            expect(result.isValid).toBe(false);
            expect(result.errors.length).toBeGreaterThan(0);
        });
    });
});
```

#### 2. 整合測試腳本

```javascript
// scripts/integration-test.js
const axios = require('axios');

class IntegrationTester {
    constructor(baseUrl = 'http://localhost:3000') {
        this.baseUrl = baseUrl;
    }

    async runAllTests() {
        console.log('🧪 開始整合測試...');
        
        const tests = [
            this.testOrderProcessing,
            this.testDashboardAPI,
            this.testMakeBridgeAuth,
            this.testErrorHandling
        ];

        for (const test of tests) {
            try {
                await test.call(this);
                console.log(`✅ ${test.name} 通過`);
            } catch (error) {
                console.log(`❌ ${test.name} 失敗:`, error.message);
            }
        }
        
        console.log('🧪 整合測試完成');
    }

    async testOrderProcessing() {
        const testOrder = {
            orderId: 'ORD-TEST-001',
            customer: {
                id: 'CUST-TEST-001',
                name: '測試客戶',
                email: 'test@example.com',
                tier: 'VIP'
            },
            items: [{
                productId: 'PROD-001',
                productName: '測試商品',
                quantity: 2,
                unitPrice: 1000,
                totalPrice: 2000
            }],
            order: {
                subtotal: 2000,
                shipping: 100,
                tax: 200,
                total: 2300
            }
        };

        const response = await axios.post(`${this.baseUrl}/api/orders/process`, testOrder);
        
        if (response.status !== 200 || !response.data.success) {
            throw new Error('訂單處理 API 測試失敗');
        }
    }

    async testDashboardAPI() {
        const statsResponse = await axios.get(`${this.baseUrl}/api/dashboard/stats`);
        const ordersResponse = await axios.get(`${this.baseUrl}/api/orders/recent`);
        
        if (statsResponse.status !== 200 || ordersResponse.status !== 200) {
            throw new Error('儀表板 API 測試失敗');
        }
    }

    async testMakeBridgeAuth() {
        const response = await axios.post(`${this.baseUrl}/api/auth/token`, {
            userId: 'test@example.com'
        });
        
        if (response.status !== 200 || !response.data.token) {
            throw new Error('Make Bridge 認證測試失敗');
        }
    }

    async testErrorHandling() {
        try {
            await axios.post(`${this.baseUrl}/api/orders/process`, {});
            throw new Error('應該回傳錯誤');
        } catch (error) {
            if (error.response?.status !== 500) {
                throw new Error('錯誤處理測試失敗');
            }
        }
    }
}

// 執行測試
if (require.main === module) {
    const tester = new IntegrationTester();
    tester.runAllTests();
}
```

### 📊 效能監控

```javascript
// monitoring/performance.js
const prometheus = require('prom-client');

// 建立監控指標
const httpRequestDuration = new prometheus.Histogram({
    name: 'http_request_duration_seconds',
    help: 'HTTP 請求處理時間',
    labelNames: ['method', 'route', 'status_code']
});

const orderProcessingCounter = new prometheus.Counter({
    name: 'orders_processed_total',
    help: '已處理的訂單總數',
    labelNames: ['priority', 'status']
});

const makeBridgeErrors = new prometheus.Counter({
    name: 'make_bridge_errors_total',
    help: 'Make Bridge 錯誤總數',
    labelNames: ['error_type']
});

// 中間件：記錄請求時間
function recordHttpMetrics(req, res, next) {
    const start = Date.now();
    
    res.on('finish', () => {
        const duration = (Date.now() - start) / 1000;
        httpRequestDuration
            .labels(req.method, req.route?.path || req.path, res.statusCode)
            .observe(duration);
    });
    
    next();
}

module.exports = {
    httpRequestDuration,
    orderProcessingCounter,
    makeBridgeErrors,
    recordHttpMetrics,
    register: prometheus.register
};
```

## 6.6 本章總結

完成本章後，您已經建立了一個功能完整的中級電商訂單追蹤系統，包括：

✅ **複雜的 Make Bridge 工作流程設計**  
✅ **進階的管理儀表板介面**  
✅ **完整的後端 API 服務**  
✅ **系統監控和測試機制**  
✅ **錯誤處理和異常恢復**  

### 📈 技術提升

通過本項目，您學會了：
- 設計多條件分支的自動化流程
- 建立響應式的管理介面
- 實作複雜的資料驗證和轉換邏輯
- 整合多個外部系統和 API
- 建立監控和日誌系統

### 🚀 下一步

中級專案完成後，下一章將帶您進入高級專案實作，學習企業級的架構設計和大規模部署技巧。