# ç¬¬6ç« ï¼šå®Œæ•´å°ˆæ¡ˆå¯¦ä½œ - ä¸­ç´š

å»ºç«‹åœ¨åˆç´šå°ˆæ¡ˆçš„åŸºç¤ä¸Šï¼Œæœ¬ç« å°‡å¸¶æ‚¨é–‹ç™¼ä¸€å€‹æ›´è¤‡é›œçš„ã€Œé›»å•†è¨‚å–®è¿½è¹¤è‡ªå‹•åŒ–ç³»çµ±ã€ã€‚é€™å€‹ä¸­ç´šå°ˆæ¡ˆå°‡æ¶µè“‹å¤šæ­¥é©Ÿå·¥ä½œæµç¨‹ã€æ¢ä»¶é‚è¼¯ã€è³‡æ–™è½‰æ›ä»¥åŠå¤šå¹³å°æ•´åˆã€‚

## 6.1 å°ˆæ¡ˆæ¦‚è¿°

### ğŸ¯ å°ˆæ¡ˆç›®æ¨™

å»ºç«‹ä¸€å€‹æ™ºèƒ½çš„é›»å•†è¨‚å–®è¿½è¹¤ç³»çµ±ï¼Œç•¶å®¢æˆ¶ä¸‹å–®æ™‚è‡ªå‹•ï¼š
1. é©—è­‰è¨‚å–®è³‡è¨Šå’Œåº«å­˜ç‹€æ…‹
2. æ ¹æ“šè¨‚å–®é‡‘é¡å’Œå®¢æˆ¶ç­‰ç´šæ±ºå®šè™•ç†å„ªå…ˆç´š
3. è‡ªå‹•åˆ†é…åˆ°ä¸åŒçš„è™•ç†åœ˜éšŠ
4. ç™¼é€å€‹äººåŒ–çš„è¨‚å–®ç¢ºèªéƒµä»¶
5. æ›´æ–°å¤šå€‹ç³»çµ±çš„åº«å­˜å’Œè²¡å‹™è¨˜éŒ„
6. è¨­å®šè‡ªå‹•åŒ–çš„ç‰©æµè¿½è¹¤é€šçŸ¥

### ğŸ“‹ æ¥­å‹™è¤‡é›œåº¦

**ä¸­ç´šå°ˆæ¡ˆç‰¹è‰²ï¼š**
- å¤šæ¢ä»¶åˆ†æ”¯é‚è¼¯
- è³‡æ–™è½‰æ›å’Œé‹ç®—
- å¤šç³»çµ±æ•´åˆ
- ç•°å¸¸è™•ç†å’Œå›æ»¾æ©Ÿåˆ¶
- å®¢æˆ¶åˆ†ç¾¤è™•ç†
- å‹•æ…‹å…§å®¹ç”Ÿæˆ

### ğŸ—ï¸ ç³»çµ±æ¶æ§‹

```
é›»å•†è¨‚å–®è¿½è¹¤ç³»çµ±
â”œâ”€â”€ è¨‚å–®æ¥æ”¶å±¤
â”‚   â”œâ”€â”€ REST API ç«¯é»
â”‚   â”œâ”€â”€ Webhook æ¥æ”¶å™¨
â”‚   â””â”€â”€ è³‡æ–™é©—è­‰æ¨¡çµ„
â”œâ”€â”€ Make Bridge æ ¸å¿ƒé‚è¼¯
â”‚   â”œâ”€â”€ è¨‚å–®é©—è­‰æµç¨‹
â”‚   â”œâ”€â”€ å®¢æˆ¶åˆ†ç´šè·¯ç”±
â”‚   â”œâ”€â”€ åº«å­˜ç®¡ç†æ•´åˆ
â”‚   â”œâ”€â”€ è²¡å‹™ç³»çµ±åŒæ­¥
â”‚   â””â”€â”€ é€šçŸ¥ç™¼é€å¼•æ“
â”œâ”€â”€ å¤–éƒ¨ç³»çµ±æ•´åˆ
â”‚   â”œâ”€â”€ ERP ç³»çµ±
â”‚   â”œâ”€â”€ CRM å¹³å°
â”‚   â”œâ”€â”€ ç‰©æµ API
â”‚   â””â”€â”€ é‡‘æµæœå‹™
â””â”€â”€ ç›£æ§å’Œåˆ†æ
    â”œâ”€â”€ è¨‚å–®ç‹€æ…‹è¿½è¹¤
    â”œâ”€â”€ æ•ˆèƒ½ç›£æ§
    â””â”€â”€ ç•°å¸¸è­¦å ±
```

## 6.2 æ­¥é©Ÿ 1ï¼šè¨­è¨ˆè¤‡é›œçš„ Make Bridge æ¨¡æ¿

### ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹è¨­è¨ˆ

**ğŸ“ åŸºæ–¼åŸæ–‡æª”é 17-21ï¼š**è¨­è¨ˆåŒ…å«å¤šå€‹åˆ†æ”¯å’Œæ¢ä»¶çš„è¤‡é›œæ¨¡æ¿ã€‚

#### ä¸»æµç¨‹çµæ§‹

```
1. [Webhook] è¨‚å–®æ¥æ”¶
    â†“
2. [Data Transformer] è³‡æ–™æ¨™æº–åŒ–
    â†“
3. [Router] è¨‚å–®é¡å‹åˆ†é¡
    â”œâ”€â”€ ä¸€èˆ¬è¨‚å–® â†’ 4a
    â”œâ”€â”€ VIP è¨‚å–® â†’ 4b  
    â””â”€â”€ æ‰¹é‡è¨‚å–® â†’ 4c
    â†“
4a. [HTTP] åº«å­˜æª¢æŸ¥ â†’ 5a
4b. [HTTP] VIP å¿«é€Ÿè™•ç† â†’ 5b
4c. [HTTP] æ‰¹é‡é©—è­‰ â†’ 5c
    â†“
5a-c. [Aggregator] åˆä½µè™•ç†çµæœ
    â†“
6. [Router] åº«å­˜ç‹€æ…‹è·¯ç”±
    â”œâ”€â”€ æœ‰åº«å­˜ â†’ 7a
    â””â”€â”€ ç¼ºè²¨ â†’ 7b
    â†“
7a. [HTTP] å»ºç«‹å‡ºè²¨å–® â†’ 8a
7b. [Email] ç¼ºè²¨é€šçŸ¥ â†’ 8b
    â†“
8a. [Multi] åŒæ­¥æ›´æ–°
    â”œâ”€â”€ Google Sheets (åº«å­˜)
    â”œâ”€â”€ Airtable (è¨‚å–®)
    â””â”€â”€ Slack (åœ˜éšŠé€šçŸ¥)
    â†“
9. [Gmail] å®¢æˆ¶ç¢ºèªéƒµä»¶
    â†“
10. [HTTP] è¨­å®šè¿½è¹¤é€šçŸ¥
```

### ğŸ”§ é—œéµæ¨¡çµ„è©³ç´°è¨­å®š

#### æ¨¡çµ„ 1ï¼šWebhook è§¸ç™¼å™¨è¨­å®š

```javascript
// è¨‚å–®è³‡æ–™çµæ§‹å®šç¾©
{
  "orderId": "ORD-2025-0001",
  "customer": {
    "id": "CUST-12345",
    "name": "ç‹å°æ˜",
    "email": "customer@example.com",
    "tier": "VIP", // Standard, VIP, Premium
    "phone": "+886-912-345-678"
  },
  "items": [
    {
      "productId": "PROD-001",
      "productName": "ç„¡ç·šè—ç‰™è€³æ©Ÿ",
      "quantity": 2,
      "unitPrice": 2990,
      "totalPrice": 5980
    }
  ],
  "order": {
    "subtotal": 5980,
    "shipping": 150,
    "tax": 599,
    "total": 6729,
    "currency": "TWD",
    "paymentMethod": "credit_card",
    "shippingAddress": {
      "name": "ç‹å°æ˜",
      "phone": "+886-912-345-678",
      "address": "å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ",
      "postalCode": "110"
    }
  },
  "metadata": {
    "source": "online_store",
    "timestamp": "2025-01-15T14:30:00Z",
    "ip": "1.2.3.4",
    "userAgent": "Mozilla/5.0..."
  }
}
```

**Webhook æ¬„ä½è¨­å®šï¼š**
```javascript
{
  "webhookName": {
    "showInTemplate": true,
    "label": "è¨‚å–®æ¥æ”¶ Webhook",
    "hint": "ç”¨æ–¼æ¥æ”¶é›»å•†å¹³å°çš„è¨‚å–®è³‡æ–™"
  },
  "expectedStructure": {
    "showInTemplate": false,
    "useValueInTemplate": true,
    "defaultValue": "ä¸Šè¿° JSON çµæ§‹"
  }
}
```

#### æ¨¡çµ„ 2ï¼šè³‡æ–™è½‰æ›å™¨è¨­å®š

```javascript
// Data Transformer è¨­å®š
{
  "transformations": [
    {
      "field": "customerTierScore",
      "formula": "switch({{customer.tier}}, 'Standard', 1, 'VIP', 2, 'Premium', 3, 1)"
    },
    {
      "field": "priorityLevel", 
      "formula": "{{order.total}} > 10000 ? 'HIGH' : {{customerTierScore}} >= 2 ? 'MEDIUM' : 'NORMAL'"
    },
    {
      "field": "processingDeadline",
      "formula": "addDays(now(), {{priorityLevel}} == 'HIGH' ? 1 : {{priorityLevel}} == 'MEDIUM' ? 2 : 3)"
    },
    {
      "field": "orderCategory",
      "formula": "{{items.length}} > 5 ? 'BULK' : {{customer.tier}} == 'Premium' ? 'VIP' : 'STANDARD'"
    }
  ]
}
```

#### æ¨¡çµ„ 3ï¼šRouter æ¢ä»¶åˆ†æµè¨­å®š

```javascript
// Router è¨­å®š
{
  "routes": [
    {
      "name": "VIPå¿«é€Ÿé€šé“",
      "condition": "{{orderCategory}} == 'VIP' OR {{priorityLevel}} == 'HIGH'",
      "label": "VIP æˆ–é«˜åƒ¹å€¼è¨‚å–®",
      "showInTemplate": true
    },
    {
      "name": "æ‰¹é‡è¨‚å–®è™•ç†",
      "condition": "{{orderCategory}} == 'BULK'",
      "label": "æ‰¹é‡è¨‚å–®ï¼ˆè¶…é5é …å•†å“ï¼‰",
      "showInTemplate": true
    },
    {
      "name": "ä¸€èˆ¬è¨‚å–®è™•ç†",
      "condition": "{{orderCategory}} == 'STANDARD'",
      "label": "æ¨™æº–è¨‚å–®è™•ç†æµç¨‹",
      "showInTemplate": true
    }
  ]
}
```

#### æ¨¡çµ„ 4ï¼šåº«å­˜æª¢æŸ¥ HTTP æ¨¡çµ„

```javascript
// HTTP åº«å­˜æª¢æŸ¥è¨­å®š
{
  "url": {
    "showInTemplate": true,
    "label": "åº«å­˜ç³»çµ± API URL",
    "hint": "ERP ç³»çµ±çš„åº«å­˜æŸ¥è©¢ç«¯é»",
    "defaultValue": "https://erp.yourcompany.com/api/inventory/check"
  },
  "method": "POST",
  "headers": {
    "showInTemplate": true,
    "useValueInTemplate": true,
    "defaultValue": {
      "Content-Type": "application/json",
      "Authorization": "Bearer {{erp.apiKey}}"
    }
  },
  "body": {
    "allowMapping": true,
    "defaultValue": {
      "orderId": "{{orderId}}",
      "items": "{{items}}",
      "priorityLevel": "{{priorityLevel}}"
    }
  }
}
```

#### æ¨¡çµ„ 5ï¼šå®¢æˆ¶é€šçŸ¥éƒµä»¶æ¨¡çµ„

```javascript
// Gmail å€‹äººåŒ–éƒµä»¶è¨­å®š
{
  "to": "{{customer.email}}",
  "subject": {
    "showInTemplate": true,
    "useValueInTemplate": true,
    "defaultValue": "è¨‚å–®ç¢ºèª {{orderId}} - æ„Ÿè¬æ‚¨çš„è³¼è²·ï¼",
    "label": "éƒµä»¶ä¸»æ—¨ç¯„æœ¬"
  },
  "content": {
    "showInTemplate": true,
    "useValueInTemplate": true,
    "label": "éƒµä»¶å…§å®¹ç¯„æœ¬",
    "defaultValue": `è¦ªæ„›çš„ {{customer.name}}ï¼Œ

æ„Ÿè¬æ‚¨åœ¨æˆ‘å€‘å•†åº—çš„è³¼è²·ï¼æ‚¨çš„è¨‚å–®å·²æˆåŠŸå»ºç«‹ã€‚

ğŸ“‹ è¨‚å–®è©³æƒ…
è¨‚å–®ç·¨è™Ÿï¼š{{orderId}}
ä¸‹å–®æ™‚é–“ï¼š{{formatDate(metadata.timestamp, 'YYYY-MM-DD HH:mm')}}
è™•ç†å„ªå…ˆç´šï¼š{{priorityLevel}}

ğŸ›ï¸ å•†å“æ¸…å–®
{{#each items}}
- {{productName}} Ã— {{quantity}} = NT$ {{formatNumber(totalPrice)}}
{{/each}}

ğŸ’° é‡‘é¡æ‘˜è¦
å•†å“å°è¨ˆï¼šNT$ {{formatNumber(order.subtotal)}}
é‹è²»ï¼šNT$ {{formatNumber(order.shipping)}}
ç¨…é‡‘ï¼šNT$ {{formatNumber(order.tax)}}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¸½è¨ˆï¼šNT$ {{formatNumber(order.total)}}

ğŸ“¦ é…é€è³‡è¨Š
æ”¶ä»¶äººï¼š{{order.shippingAddress.name}}
é›»è©±ï¼š{{order.shippingAddress.phone}}
åœ°å€ï¼š{{order.shippingAddress.address}}

é è¨ˆè™•ç†æ™‚é–“ï¼š{{processingDeadline}} å‰å®Œæˆå‡ºè²¨
{{#if customer.tier == 'VIP' OR customer.tier == 'Premium'}}
ğŸŒŸ ä½œç‚º {{customer.tier}} æœƒå“¡ï¼Œæ‚¨çš„è¨‚å–®äº«æœ‰å„ªå…ˆè™•ç†ï¼
{{/if}}

å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹éš¨æ™‚è¯ç¹«æˆ‘å€‘çš„å®¢æœåœ˜éšŠã€‚

ç¥æ‚¨è³¼ç‰©æ„‰å¿«ï¼
å®¢æœåœ˜éšŠ`
  }
}
```

### ğŸ“Š æ¨¡æ¿æ¬„ä½ä½¿ç”¨è€…è¨­å®š

**ä½¿ç”¨è€…éœ€è¦è¨­å®šçš„é—œéµæ¬„ä½ï¼š**

1. **ç³»çµ±æ•´åˆè¨­å®š**
   - ERP ç³»çµ± API é‡‘é‘°å’Œç«¯é»
   - CRM ç³»çµ±é€£æ¥è³‡è¨Š
   - ç‰©æµ API è¨­å®š

2. **é€šçŸ¥è¨­å®š**
   - Gmail é€£æ¥
   - Slack å·¥ä½œå€å’Œé »é“
   - ç·Šæ€¥è¯çµ¡äººæ¸…å–®

3. **æ¥­å‹™è¦å‰‡è‡ªè¨‚**
   - VIP å®¢æˆ¶æ¨™æº–
   - å„ªå…ˆè™•ç†é‡‘é¡é–€æª»
   - è™•ç†æ™‚é–“è¨­å®š

4. **ç¯„æœ¬å€‹äººåŒ–**
   - éƒµä»¶ç¯„æœ¬å…§å®¹
   - å…¬å¸å“ç‰Œè³‡è¨Š
   - å®¢æœè¯çµ¡è³‡è¨Š

## 6.3 æ­¥é©Ÿ 2ï¼šå»ºç«‹é€²éšå‰ç«¯ç®¡ç†ä»‹é¢

### ğŸ¨ è¨‚å–®ç®¡ç†å„€è¡¨æ¿

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»å•†è¨‚å–®è¿½è¹¤ç³»çµ±</title>
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard">
        <!-- å´é‚Šå°èˆª -->
        <nav class="sidebar">
            <div class="logo">
                <h2>ğŸ“¦ è¨‚å–®ç³»çµ±</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="#dashboard" class="nav-link active"><i class="fas fa-chart-pie"></i> å„€è¡¨æ¿</a></li>
                <li><a href="#orders" class="nav-link"><i class="fas fa-shopping-cart"></i> è¨‚å–®ç®¡ç†</a></li>
                <li><a href="#automation" class="nav-link"><i class="fas fa-robot"></i> è‡ªå‹•åŒ–è¨­å®š</a></li>
                <li><a href="#settings" class="nav-link"><i class="fas fa-cog"></i> ç³»çµ±è¨­å®š</a></li>
            </ul>
        </nav>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <main class="main-content">
            <!-- æ¨™é¡Œåˆ— -->
            <header class="content-header">
                <h1 id="page-title">è¨‚å–®è¿½è¹¤å„€è¡¨æ¿</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="setupMakeBridge()">
                        <i class="fas fa-plus"></i> è¨­å®šè‡ªå‹•åŒ–
                    </button>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="fas fa-sync"></i> é‡æ–°æ•´ç†
                    </button>
                </div>
            </header>

            <!-- å„€è¡¨æ¿å…§å®¹ -->
            <div id="dashboard-section" class="content-section">
                <!-- çµ±è¨ˆå¡ç‰‡ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-orders">0</div>
                            <div class="stat-label">ä»Šæ—¥è¨‚å–®</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-revenue">$0</div>
                            <div class="stat-label">ä»Šæ—¥ç‡Ÿæ”¶</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="pending-orders">0</div>
                            <div class="stat-label">å¾…è™•ç†</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="success-rate">0%</div>
                            <div class="stat-label">è‡ªå‹•åŒ–æˆåŠŸç‡</div>
                        </div>
                    </div>
                </div>

                <!-- æœ€è¿‘è¨‚å–® -->
                <div class="content-card">
                    <div class="card-header">
                        <h3>æœ€è¿‘è¨‚å–®</h3>
                        <button class="btn btn-sm btn-outline" onclick="viewAllOrders()">
                            æŸ¥çœ‹å…¨éƒ¨
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="data-table" id="recent-orders">
                                <thead>
                                    <tr>
                                        <th>è¨‚å–®ç·¨è™Ÿ</th>
                                        <th>å®¢æˆ¶</th>
                                        <th>é‡‘é¡</th>
                                        <th>å„ªå…ˆç´š</th>
                                        <th>ç‹€æ…‹</th>
                                        <th>æ™‚é–“</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- å‹•æ…‹è¼‰å…¥å…§å®¹ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è‡ªå‹•åŒ–è¨­å®šå€ -->
            <div id="automation-section" class="content-section" style="display: none;">
                <div class="content-card">
                    <div class="card-header">
                        <h3>Make Bridge è‡ªå‹•åŒ–è¨­å®š</h3>
                    </div>
                    <div class="card-body">
                        <div id="bridge-integration-container">
                            <!-- Make Bridge æ•´åˆç²¾éˆå°‡è¼‰å…¥åœ¨é€™è£¡ -->
                        </div>
                        
                        <!-- è¨­å®šæ­¥é©ŸæŒ‡å¼• -->
                        <div class="setup-guide">
                            <h4>è¨­å®šæ­¥é©Ÿï¼š</h4>
                            <ol>
                                <li>é€£æ¥æ‚¨çš„ ERP ç³»çµ±</li>
                                <li>è¨­å®š Gmail éƒµä»¶æœå‹™</li>
                                <li>é…ç½® Slack é€šçŸ¥</li>
                                <li>è‡ªè¨‚æ¥­å‹™è¦å‰‡</li>
                                <li>æ¸¬è©¦è‡ªå‹•åŒ–æµç¨‹</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Make Bridge è¼‰å…¥ -->
    <script src="https://portal-integrations.make.com/js/portal-integrations.js"></script>
    <script src="dashboard.js"></script>
</body>
</html>
```

### ğŸ¨ é€²éš CSS æ¨£å¼

```css
/* dashboard.css - ç®¡ç†å„€è¡¨æ¿æ¨£å¼ */

:root {
    --primary-color: #2563eb;
    --secondary-color: #64748b;
    --success-color: #059669;
    --warning-color: #d97706;
    --error-color: #dc2626;
    --background-color: #f8fafc;
    --surface-color: #ffffff;
    --border-color: #e2e8f0;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --sidebar-width: 260px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: var(--background-color);
    color: var(--text-primary);
    line-height: 1.6;
}

/* å„€è¡¨æ¿ä½ˆå±€ */
.dashboard {
    display: flex;
    min-height: 100vh;
}

/* å´é‚Šæ¬„ */
.sidebar {
    width: var(--sidebar-width);
    background: var(--surface-color);
    border-right: 1px solid var(--border-color);
    padding: 20px 0;
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
}

.logo {
    padding: 0 20px;
    margin-bottom: 30px;
}

.logo h2 {
    color: var(--primary-color);
    font-size: 1.5rem;
    font-weight: 700;
}

.nav-menu {
    list-style: none;
}

.nav-menu li {
    margin-bottom: 5px;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.2s;
}

.nav-link:hover,
.nav-link.active {
    background: #f1f5f9;
    color: var(--primary-color);
    border-right: 3px solid var(--primary-color);
}

.nav-link i {
    margin-right: 12px;
    width: 20px;
    text-align: center;
}

/* ä¸»è¦å…§å®¹å€ */
.main-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

/* å…§å®¹æ¨™é¡Œ */
.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}

.content-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
}

.header-actions {
    display: flex;
    gap: 10px;
}

/* æŒ‰éˆ•æ¨£å¼ */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
}

.btn-secondary {
    background: var(--surface-color);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: #f8fafc;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 13px;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

/* çµ±è¨ˆå¡ç‰‡ç¶²æ ¼ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

/* çµ±è¨ˆå¡ç‰‡ */
.stat-card {
    background: var(--surface-color);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 16px;
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.stat-card:nth-child(1) .stat-icon {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.stat-card:nth-child(2) .stat-icon {
    background: linear-gradient(135deg, #059669, #047857);
    color: white;
}

.stat-card:nth-child(3) .stat-icon {
    background: linear-gradient(135deg, #d97706, #b45309);
    color: white;
}

.stat-card:nth-child(4) .stat-icon {
    background: linear-gradient(135deg, #7c3aed, #5b21b6);
    color: white;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-label {
    color: var(--text-secondary);
    font-size: 14px;
}

/* å…§å®¹å¡ç‰‡ */
.content-card {
    background: var(--surface-color);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-color);
}

.card-header h3 {
    font-size: 1.25rem;
    font-weight: 600;
}

.card-body {
    padding: 24px;
}

/* è¡¨æ ¼æ¨£å¼ */
.table-container {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    text-align: left;
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
}

.data-table th {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 14px;
    background: #f8fafc;
}

.data-table td {
    font-size: 14px;
}

/* ç‹€æ…‹æ¨™ç±¤ */
.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
}

.status-processing {
    background: #fef3c7;
    color: #92400e;
}

.status-completed {
    background: #d1fae5;
    color: #065f46;
}

.status-error {
    background: #fee2e2;
    color: #991b1b;
}

/* å„ªå…ˆç´šæ¨™ç±¤ */
.priority-high {
    background: #fee2e2;
    color: #991b1b;
}

.priority-medium {
    background: #fef3c7;
    color: #92400e;
}

.priority-normal {
    background: #e0e7ff;
    color: #3730a3;
}

/* è¨­å®šæŒ‡å¼• */
.setup-guide {
    margin-top: 30px;
    padding: 20px;
    background: #f8fafc;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
}

.setup-guide h4 {
    margin-bottom: 15px;
    color: var(--text-primary);
}

.setup-guide ol {
    margin-left: 20px;
}

.setup-guide li {
    margin-bottom: 8px;
    color: var(--text-secondary);
}

/* Make Bridge æ•´åˆå®¹å™¨ */
#bridge-integration-container {
    min-height: 400px;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    background: #fafafa;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 1024px) {
    .sidebar {
        width: 200px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
}

@media (max-width: 768px) {
    .dashboard {
        flex-direction: column;
    }
    
    .sidebar {
        width: 100%;
        height: auto;
    }
    
    .nav-menu {
        display: flex;
        overflow-x: auto;
    }
    
    .nav-menu li {
        margin-bottom: 0;
        margin-right: 5px;
    }
    
    .content-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .header-actions {
        width: 100%;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
}

/* å‹•ç•«æ•ˆæœ */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.content-section {
    animation: fadeInUp 0.5s ease-out;
}

/* è¼‰å…¥ç‹€æ…‹ */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
```

### âš¡ é€²éš JavaScript ç®¡ç†é‚è¼¯

```javascript
// dashboard.js - å„€è¡¨æ¿ç®¡ç†é‚è¼¯

class OrderTrackingDashboard {
    constructor() {
        this.currentSection = 'dashboard';
        this.makeBridge = null;
        this.data = {
            orders: [],
            stats: {},
            automationStatus: 'inactive'
        };
        
        this.initializeApp();
    }

    async initializeApp() {
        this.setupNavigation();
        this.loadDashboardData();
        this.setupAutoRefresh();
        
        // æª¢æŸ¥æ˜¯å¦å·²è¨­å®š Make Bridge
        await this.checkMakeBridgeStatus();
    }

    setupNavigation() {
        const navLinks = document.querySelectorAll('.nav-link');
        
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.getAttribute('href').substring(1);
                this.switchSection(section);
            });
        });
    }

    switchSection(sectionName) {
        // éš±è—æ‰€æœ‰å€å¡Š
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
        });
        
        // é¡¯ç¤ºç›®æ¨™å€å¡Š
        const targetSection = document.getElementById(`${sectionName}-section`);
        if (targetSection) {
            targetSection.style.display = 'block';
        }
        
        // æ›´æ–°å°èˆªç‹€æ…‹
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`[href="#${sectionName}"]`).classList.add('active');
        
        // æ›´æ–°é é¢æ¨™é¡Œ
        const titles = {
            'dashboard': 'è¨‚å–®è¿½è¹¤å„€è¡¨æ¿',
            'orders': 'è¨‚å–®ç®¡ç†',
            'automation': 'è‡ªå‹•åŒ–è¨­å®š',
            'settings': 'ç³»çµ±è¨­å®š'
        };
        document.getElementById('page-title').textContent = titles[sectionName] || 'è¨‚å–®ç³»çµ±';
        
        this.currentSection = sectionName;
        
        // è¼‰å…¥å€å¡Šç‰¹å®šå…§å®¹
        this.loadSectionData(sectionName);
    }

    async loadSectionData(sectionName) {
        switch (sectionName) {
            case 'dashboard':
                await this.loadDashboardData();
                break;
            case 'orders':
                await this.loadOrdersData();
                break;
            case 'automation':
                await this.loadAutomationData();
                break;
        }
    }

    async loadDashboardData() {
        try {
            this.showLoading();
            
            // ä¸¦è¡Œè¼‰å…¥çµ±è¨ˆè³‡æ–™
            const [statsData, ordersData] = await Promise.all([
                this.fetchStats(),
                this.fetchRecentOrders()
            ]);
            
            this.data.stats = statsData;
            this.data.orders = ordersData;
            
            this.updateStatsDisplay();
            this.updateOrdersTable();
            
        } catch (error) {
            console.error('è¼‰å…¥å„€è¡¨æ¿è³‡æ–™å¤±æ•—:', error);
            this.showError('ç„¡æ³•è¼‰å…¥å„€è¡¨æ¿è³‡æ–™');
        } finally {
            this.hideLoading();
        }
    }

    async fetchStats() {
        const response = await fetch('/api/dashboard/stats');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    }

    async fetchRecentOrders() {
        const response = await fetch('/api/orders/recent?limit=10');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    }

    updateStatsDisplay() {
        const stats = this.data.stats;
        
        document.getElementById('total-orders').textContent = this.formatNumber(stats.totalOrders || 0);
        document.getElementById('total-revenue').textContent = this.formatCurrency(stats.totalRevenue || 0);
        document.getElementById('pending-orders').textContent = this.formatNumber(stats.pendingOrders || 0);
        document.getElementById('success-rate').textContent = this.formatPercentage(stats.automationSuccessRate || 0);
    }

    updateOrdersTable() {
        const tbody = document.querySelector('#recent-orders tbody');
        tbody.innerHTML = '';
        
        this.data.orders.forEach(order => {
            const row = this.createOrderRow(order);
            tbody.appendChild(row);
        });
    }

    createOrderRow(order) {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>
                <div class="order-id">
                    <strong>${order.orderId}</strong>
                </div>
            </td>
            <td>
                <div class="customer-info">
                    <div>${order.customer.name}</div>
                    <div class="text-secondary">${order.customer.email}</div>
                </div>
            </td>
            <td>
                <div class="amount">
                    ${this.formatCurrency(order.total)}
                </div>
            </td>
            <td>
                <span class="status-badge priority-${order.priorityLevel.toLowerCase()}">
                    ${order.priorityLevel}
                </span>
            </td>
            <td>
                <span class="status-badge status-${order.status.toLowerCase()}">
                    ${this.getStatusText(order.status)}
                </span>
            </td>
            <td>
                <div class="timestamp">
                    ${this.formatDateTime(order.createdAt)}
                </div>
            </td>
            <td>
                <div class="actions">
                    <button class="btn btn-sm btn-outline" onclick="viewOrderDetails('${order.orderId}')">
                        æŸ¥çœ‹
                    </button>
                </div>
            </td>
        `;
        
        return row;
    }

    async checkMakeBridgeStatus() {
        try {
            const response = await fetch('/api/automation/status');
            const status = await response.json();
            
            this.data.automationStatus = status.isActive ? 'active' : 'inactive';
            
            if (status.isActive) {
                this.initializeMakeBridge();
            }
            
        } catch (error) {
            console.error('æª¢æŸ¥è‡ªå‹•åŒ–ç‹€æ…‹å¤±æ•—:', error);
        }
    }

    async setupMakeBridge() {
        this.switchSection('automation');
        
        if (!this.makeBridge) {
            await this.initializeMakeBridge();
        }
        
        // å•Ÿå‹•æ•´åˆç²¾éˆ
        try {
            const templateId = await this.getTemplateId();
            await this.makeBridge.startIntegration(templateId);
        } catch (error) {
            console.error('å•Ÿå‹• Make Bridge å¤±æ•—:', error);
            this.showError('ç„¡æ³•å•Ÿå‹•è‡ªå‹•åŒ–è¨­å®š');
        }
    }

    async initializeMakeBridge() {
        if (typeof window.PortalIntegrations === 'undefined') {
            throw new Error('Make Bridge è…³æœ¬æœªè¼‰å…¥');
        }

        const config = {
            container: '#bridge-integration-container',
            userId: 'admin@company.com', // å¯¦éš›éƒ¨ç½²æ™‚æ‡‰è©²æ˜¯å‹•æ…‹çš„
            zoneUrl: 'https://eu2.make.com',
            onSuccess: this.handleMakeBridgeSuccess.bind(this),
            onError: this.handleMakeBridgeError.bind(this),
            onClose: this.handleMakeBridgeClose.bind(this)
        };

        this.makeBridge = new MakeBridgeIntegration(config);
        await this.makeBridge.initialize();
    }

    async getTemplateId() {
        const response = await fetch('/api/automation/template-id');
        const data = await response.json();
        return data.templateId;
    }

    handleMakeBridgeSuccess(result) {
        console.log('Make Bridge è¨­å®šæˆåŠŸ:', result);
        this.data.automationStatus = 'active';
        this.showSuccess('è‡ªå‹•åŒ–è¨­å®šå®Œæˆï¼ç³»çµ±å°‡é–‹å§‹è‡ªå‹•è™•ç†è¨‚å–®ã€‚');
        
        // é‡æ–°è¼‰å…¥å„€è¡¨æ¿è³‡æ–™
        this.loadDashboardData();
    }

    handleMakeBridgeError(error) {
        console.error('Make Bridge è¨­å®šå¤±æ•—:', error);
        this.showError('è‡ªå‹•åŒ–è¨­å®šå¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šæˆ–è¯ç¹«æŠ€è¡“æ”¯æ´ã€‚');
    }

    handleMakeBridgeClose() {
        console.log('Make Bridge è¨­å®šå·²é—œé–‰');
    }

    setupAutoRefresh() {
        // æ¯30ç§’è‡ªå‹•æ›´æ–°å„€è¡¨æ¿
        setInterval(() => {
            if (this.currentSection === 'dashboard') {
                this.loadDashboardData();
            }
        }, 30000);
    }

    // å·¥å…·å‡½æ•¸
    formatNumber(number) {
        return new Intl.NumberFormat('zh-TW').format(number);
    }

    formatCurrency(amount) {
        return new Intl.NumberFormat('zh-TW', {
            style: 'currency',
            currency: 'TWD'
        }).format(amount);
    }

    formatPercentage(value) {
        return `${Math.round(value * 100)}%`;
    }

    formatDateTime(timestamp) {
        return new Intl.DateTimeFormat('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        }).format(new Date(timestamp));
    }

    getStatusText(status) {
        const statusMap = {
            'processing': 'è™•ç†ä¸­',
            'completed': 'å·²å®Œæˆ',
            'error': 'éŒ¯èª¤',
            'pending': 'å¾…è™•ç†'
        };
        return statusMap[status] || status;
    }

    showLoading() {
        // å¯¦ä½œè¼‰å…¥ç‹€æ…‹é¡¯ç¤º
    }

    hideLoading() {
        // å¯¦ä½œè¼‰å…¥ç‹€æ…‹éš±è—
    }

    showSuccess(message) {
        this.showNotification(message, 'success');
    }

    showError(message) {
        this.showNotification(message, 'error');
    }

    showNotification(message, type) {
        // å¯¦ä½œé€šçŸ¥é¡¯ç¤ºé‚è¼¯
        console.log(`${type.toUpperCase()}: ${message}`);
    }
}

// Make Bridge æ•´åˆé¡åˆ¥ï¼ˆä¾†è‡ªç¬¬5ç« ï¼Œé€™è£¡ç°¡åŒ–ç‰ˆæœ¬ï¼‰
class MakeBridgeIntegration {
    constructor(config) {
        this.config = config;
        this.isInitialized = false;
    }

    async initialize() {
        // åˆå§‹åŒ– Make Bridge
        this.isInitialized = true;
    }

    async startIntegration(templateId) {
        const token = await this.getAuthToken();
        
        window.PortalIntegrations.init({
            token: token,
            templateId: templateId,
            container: this.config.container,
            onSuccess: this.config.onSuccess,
            onError: this.config.onError,
            onClose: this.config.onClose
        });
    }

    async getAuthToken() {
        const response = await fetch('/api/auth/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: this.config.userId })
        });
        
        const data = await response.json();
        return data.token;
    }
}

// å…¨åŸŸå‡½æ•¸
function refreshData() {
    if (window.dashboard) {
        window.dashboard.loadSectionData(window.dashboard.currentSection);
    }
}

function viewOrderDetails(orderId) {
    // å¯¦ä½œè¨‚å–®è©³æƒ…æŸ¥çœ‹
    console.log('æŸ¥çœ‹è¨‚å–®:', orderId);
}

function viewAllOrders() {
    if (window.dashboard) {
        window.dashboard.switchSection('orders');
    }
}

// åˆå§‹åŒ–æ‡‰ç”¨
document.addEventListener('DOMContentLoaded', () => {
    window.dashboard = new OrderTrackingDashboard();
});
```

## 6.4 æ­¥é©Ÿ 3ï¼šå¾Œç«¯ API æœå‹™é€²éšå¯¦ä½œ

### ğŸ”§ å®Œæ•´çš„ Express ä¼ºæœå™¨

```javascript
// server.js - é›»å•†è¨‚å–®è¿½è¹¤ç³»çµ±å¾Œç«¯
const express = require('express');
const jwt = require('jsonwebtoken');
const crypto = require('crypto');
const cors = require('cors');
const rateLimit = require('express-rate-limit');
const helmet = require('helmet');
const winston = require('winston');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// æ—¥èªŒè¨­å®š
const logger = winston.createLogger({
    level: 'info',
    format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.json()
    ),
    transports: [
        new winston.transports.File({ filename: 'error.log', level: 'error' }),
        new winston.transports.File({ filename: 'combined.log' })
    ]
});

if (process.env.NODE_ENV !== 'production') {
    logger.add(new winston.transports.Console({
        format: winston.format.simple()
    }));
}

// å®‰å…¨æ€§ä¸­é–“ä»¶
app.use(helmet());
app.use(cors({
    origin: process.env.FRONTEND_URL || 'http://localhost:3000',
    credentials: true
}));

// è«‹æ±‚é »ç‡é™åˆ¶
const apiLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 åˆ†é˜
    max: 100 // æœ€å¤š 100 æ¬¡è«‹æ±‚
});
app.use('/api/', apiLimiter);

const orderLimiter = rateLimit({
    windowMs: 60 * 1000, // 1 åˆ†é˜
    max: 10 // æœ€å¤š 10 æ¬¡è¨‚å–®è™•ç†
});
app.use('/api/orders/process', orderLimiter);

app.use(express.json({ limit: '10mb' }));
app.use(express.static('public'));

// Make Bridge è¨­å®š
const MAKE_CONFIG = {
    secret: process.env.MAKE_BRIDGE_SECRET,
    keyId: process.env.MAKE_BRIDGE_KEY_ID,
    zoneUrl: process.env.MAKE_ZONE_URL || 'https://eu2.make.com',
    templateId: process.env.ORDER_TRACKING_TEMPLATE_ID
};

/**
 * è¨‚å–®è™•ç†æœå‹™
 */
class OrderProcessingService {
    constructor(config) {
        this.config = config;
        this.authManager = new MakeBridgeAuthManager(config);
    }

    /**
     * è™•ç†æ–°è¨‚å–®
     */
    async processOrder(orderData) {
        try {
            // 1. é©—è­‰è¨‚å–®è³‡æ–™
            const validation = this.validateOrderData(orderData);
            if (!validation.isValid) {
                throw new Error(`è¨‚å–®é©—è­‰å¤±æ•—: ${validation.errors.join(', ')}`);
            }

            // 2. è±å¯Œè¨‚å–®è³‡æ–™
            const enrichedOrder = await this.enrichOrderData(orderData);

            // 3. æäº¤åˆ° Make Bridge
            const result = await this.submitToMakeBridge(enrichedOrder);

            // 4. è¨˜éŒ„è™•ç†çµæœ
            logger.info('è¨‚å–®è™•ç†æˆåŠŸ', {
                orderId: orderData.orderId,
                customerId: orderData.customer.id,
                total: orderData.order.total,
                priority: enrichedOrder.priorityLevel
            });

            return {
                success: true,
                orderId: orderData.orderId,
                integrationId: result.integrationId,
                priority: enrichedOrder.priorityLevel,
                estimatedProcessingTime: enrichedOrder.processingDeadline
            };

        } catch (error) {
            logger.error('è¨‚å–®è™•ç†å¤±æ•—', {
                orderId: orderData.orderId,
                error: error.message
            });
            throw error;
        }
    }

    validateOrderData(data) {
        const errors = [];
        
        // åŸºæœ¬å¿…å¡«æ¬„ä½æª¢æŸ¥
        if (!data.orderId) errors.push('ç¼ºå°‘è¨‚å–®ç·¨è™Ÿ');
        if (!data.customer?.email) errors.push('ç¼ºå°‘å®¢æˆ¶ Email');
        if (!data.customer?.name) errors.push('ç¼ºå°‘å®¢æˆ¶å§“å');
        if (!data.items?.length) errors.push('è¨‚å–®é …ç›®ä¸èƒ½ç‚ºç©º');
        if (!data.order?.total) errors.push('ç¼ºå°‘è¨‚å–®ç¸½é‡‘é¡');

        // å•†å“é …ç›®æª¢æŸ¥
        data.items?.forEach((item, index) => {
            if (!item.productId) errors.push(`å•†å“ ${index + 1} ç¼ºå°‘ç”¢å“ ID`);
            if (!item.quantity || item.quantity <= 0) errors.push(`å•†å“ ${index + 1} æ•¸é‡ç„¡æ•ˆ`);
            if (!item.unitPrice || item.unitPrice <= 0) errors.push(`å•†å“ ${index + 1} å–®åƒ¹ç„¡æ•ˆ`);
        });

        // Email æ ¼å¼æª¢æŸ¥
        if (data.customer?.email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(data.customer.email)) {
                errors.push('å®¢æˆ¶ Email æ ¼å¼ä¸æ­£ç¢º');
            }
        }

        // é‡‘é¡ä¸€è‡´æ€§æª¢æŸ¥
        if (data.items?.length && data.order?.subtotal) {
            const calculatedSubtotal = data.items.reduce((sum, item) => sum + item.totalPrice, 0);
            if (Math.abs(calculatedSubtotal - data.order.subtotal) > 1) {
                errors.push('å•†å“å°è¨ˆèˆ‡å¯¦éš›è¨ˆç®—ä¸ç¬¦');
            }
        }

        return {
            isValid: errors.length === 0,
            errors: errors
        };
    }

    async enrichOrderData(orderData) {
        const enriched = { ...orderData };

        // è¨ˆç®—å®¢æˆ¶ç­‰ç´šåˆ†æ•¸
        const tierScores = { 'Standard': 1, 'VIP': 2, 'Premium': 3 };
        enriched.customerTierScore = tierScores[orderData.customer.tier] || 1;

        // è¨ˆç®—å„ªå…ˆç´š
        if (orderData.order.total > 10000) {
            enriched.priorityLevel = 'HIGH';
        } else if (enriched.customerTierScore >= 2) {
            enriched.priorityLevel = 'MEDIUM';
        } else {
            enriched.priorityLevel = 'NORMAL';
        }

        // è¨ˆç®—è™•ç†æœŸé™
        const processingDays = {
            'HIGH': 1,
            'MEDIUM': 2,
            'NORMAL': 3
        };
        const deadline = new Date();
        deadline.setDate(deadline.getDate() + processingDays[enriched.priorityLevel]);
        enriched.processingDeadline = deadline.toISOString();

        // è¨‚å–®åˆ†é¡
        if (orderData.items.length > 5) {
            enriched.orderCategory = 'BULK';
        } else if (orderData.customer.tier === 'Premium') {
            enriched.orderCategory = 'VIP';
        } else {
            enriched.orderCategory = 'STANDARD';
        }

        // æ·»åŠ è™•ç†æ™‚é–“æˆ³è¨˜
        enriched.processedAt = new Date().toISOString();

        return enriched;
    }

    async submitToMakeBridge(orderData) {
        const token = this.authManager.generateToken(orderData.customer.email);
        
        const url = `${this.config.zoneUrl}/portal/api/bridge/integrations/init/${this.config.templateId}`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                autoActivate: true,
                data: orderData
            })
        });

        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(`Make Bridge API éŒ¯èª¤: ${response.status} - ${errorData}`);
        }

        return response.json();
    }
}

/**
 * å„€è¡¨æ¿è³‡æ–™æœå‹™
 */
class DashboardService {
    async getStats() {
        // æ¨¡æ“¬çµ±è¨ˆè³‡æ–™ï¼ˆå¯¦éš›æ‡‰ç”¨æ‡‰å¾è³‡æ–™åº«ç²å–ï¼‰
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        
        return {
            totalOrders: 42,
            totalRevenue: 128500,
            pendingOrders: 7,
            automationSuccessRate: 0.95,
            averageProcessingTime: 1.2, // å°æ™‚
            topProducts: [
                { name: 'ç„¡ç·šè—ç‰™è€³æ©Ÿ', count: 15 },
                { name: 'æ™ºèƒ½æ‰‹éŒ¶', count: 12 },
                { name: 'æ‰‹æ©Ÿæ®¼', count: 8 }
            ]
        };
    }

    async getRecentOrders(limit = 10) {
        // æ¨¡æ“¬æœ€è¿‘è¨‚å–®è³‡æ–™
        const orders = [];
        for (let i = 1; i <= limit; i++) {
            orders.push({
                orderId: `ORD-2025-${String(i).padStart(4, '0')}`,
                customer: {
                    name: `å®¢æˆ¶ ${i}`,
                    email: `customer${i}@example.com`,
                    tier: ['Standard', 'VIP', 'Premium'][i % 3]
                },
                total: Math.floor(Math.random() * 20000) + 1000,
                priorityLevel: ['NORMAL', 'MEDIUM', 'HIGH'][i % 3],
                status: ['processing', 'completed', 'pending'][i % 3],
                createdAt: new Date(Date.now() - i * 3600000).toISOString()
            });
        }
        return orders;
    }
}

// åˆå§‹åŒ–æœå‹™
const orderService = new OrderProcessingService(MAKE_CONFIG);
const dashboardService = new DashboardService();

/**
 * API è·¯ç”±ï¼šè™•ç†æ–°è¨‚å–®
 */
app.post('/api/orders/process', async (req, res) => {
    try {
        const orderData = req.body;
        
        logger.info('æ¥æ”¶æ–°è¨‚å–®', {
            orderId: orderData.orderId,
            customerId: orderData.customer?.id
        });

        const result = await orderService.processOrder(orderData);
        
        res.json(result);
        
    } catch (error) {
        logger.error('è¨‚å–®è™•ç† API éŒ¯èª¤', {
            error: error.message,
            orderData: req.body
        });
        
        res.status(500).json({
            success: false,
            error: 'è¨‚å–®è™•ç†å¤±æ•—',
            message: error.message
        });
    }
});

/**
 * API è·¯ç”±ï¼šå–å¾—å„€è¡¨æ¿çµ±è¨ˆ
 */
app.get('/api/dashboard/stats', async (req, res) => {
    try {
        const stats = await dashboardService.getStats();
        res.json(stats);
    } catch (error) {
        logger.error('å–å¾—çµ±è¨ˆè³‡æ–™å¤±æ•—', { error: error.message });
        res.status(500).json({ error: 'ç„¡æ³•å–å¾—çµ±è¨ˆè³‡æ–™' });
    }
});

/**
 * API è·¯ç”±ï¼šå–å¾—æœ€è¿‘è¨‚å–®
 */
app.get('/api/orders/recent', async (req, res) => {
    try {
        const limit = parseInt(req.query.limit) || 10;
        const orders = await dashboardService.getRecentOrders(limit);
        res.json(orders);
    } catch (error) {
        logger.error('å–å¾—è¨‚å–®åˆ—è¡¨å¤±æ•—', { error: error.message });
        res.status(500).json({ error: 'ç„¡æ³•å–å¾—è¨‚å–®åˆ—è¡¨' });
    }
});

/**
 * API è·¯ç”±ï¼šè‡ªå‹•åŒ–ç‹€æ…‹æª¢æŸ¥
 */
app.get('/api/automation/status', async (req, res) => {
    try {
        const isActive = !!MAKE_CONFIG.templateId;
        res.json({
            isActive: isActive,
            templateId: MAKE_CONFIG.templateId,
            lastCheck: new Date().toISOString()
        });
    } catch (error) {
        res.status(500).json({ error: 'ç„¡æ³•æª¢æŸ¥è‡ªå‹•åŒ–ç‹€æ…‹' });
    }
});

/**
 * API è·¯ç”±ï¼šå–å¾—æ¨¡æ¿ ID
 */
app.get('/api/automation/template-id', (req, res) => {
    if (!MAKE_CONFIG.templateId) {
        return res.status(404).json({ error: 'å°šæœªè¨­å®šæ¨¡æ¿ ID' });
    }
    
    res.json({ templateId: MAKE_CONFIG.templateId });
});

/**
 * API è·¯ç”±ï¼šJWT Token ç”Ÿæˆ
 */
app.post('/api/auth/token', (req, res) => {
    try {
        const { userId } = req.body;
        
        if (!userId) {
            return res.status(400).json({ error: 'userId åƒæ•¸æ˜¯å¿…è¦çš„' });
        }

        const authManager = new MakeBridgeAuthManager(MAKE_CONFIG);
        const token = authManager.generateToken(userId);
        
        res.json({
            token: token,
            expiresIn: 120,
            tokenType: 'Bearer'
        });
        
    } catch (error) {
        logger.error('Token ç”Ÿæˆå¤±æ•—', { error: error.message });
        res.status(500).json({ error: 'Token ç”Ÿæˆå¤±æ•—' });
    }
});

/**
 * éŒ¯èª¤è™•ç†ä¸­é–“ä»¶
 */
app.use((error, req, res, next) => {
    logger.error('æœªè™•ç†çš„éŒ¯èª¤', {
        error: error.message,
        stack: error.stack,
        url: req.url,
        method: req.method
    });
    
    res.status(500).json({
        error: 'å…§éƒ¨ä¼ºæœå™¨éŒ¯èª¤',
        message: process.env.NODE_ENV === 'development' ? error.message : 'è«‹ç¨å¾Œå†è©¦'
    });
});

/**
 * JWT èªè­‰ç®¡ç†å™¨
 */
class MakeBridgeAuthManager {
    constructor(config) {
        this.secret = config.secret;
        this.keyId = config.keyId;
        
        if (!this.secret || !this.keyId) {
            throw new Error('Make Bridge èªè­‰è¨­å®šä¸å®Œæ•´');
        }
    }

    generateToken(userId) {
        return jwt.sign(
            {
                sub: userId,
                jti: crypto.randomUUID(),
            },
            this.secret,
            {
                expiresIn: '2m',
                keyid: this.keyId,
            }
        );
    }
}

/**
 * å•Ÿå‹•ä¼ºæœå™¨
 */
app.listen(PORT, () => {
    logger.info('é›»å•†è¨‚å–®è¿½è¹¤ç³»çµ±å·²å•Ÿå‹•', {
        port: PORT,
        nodeEnv: process.env.NODE_ENV,
        makeZoneUrl: MAKE_CONFIG.zoneUrl,
        hasTemplateId: !!MAKE_CONFIG.templateId
    });
});

module.exports = app;
```

## 6.5 æ­¥é©Ÿ 4ï¼šæ•´åˆæ¸¬è©¦èˆ‡å„ªåŒ–

### ğŸ§ª ç³»çµ±æ¸¬è©¦æµç¨‹

#### 1. å–®å…ƒæ¸¬è©¦

```javascript
// tests/order-processing.test.js
const { OrderProcessingService } = require('../server');

describe('OrderProcessingService', () => {
    let service;
    
    beforeEach(() => {
        service = new OrderProcessingService({
            secret: 'test_secret',
            keyId: 'test_key_id',
            zoneUrl: 'https://test.make.com',
            templateId: 'test_template_id'
        });
    });

    describe('validateOrderData', () => {
        test('æ‡‰è©²é©—è­‰æœ‰æ•ˆçš„è¨‚å–®è³‡æ–™', () => {
            const validOrder = {
                orderId: 'ORD-TEST-001',
                customer: {
                    id: 'CUST-001',
                    name: 'æ¸¬è©¦å®¢æˆ¶',
                    email: 'test@example.com',
                    tier: 'VIP'
                },
                items: [{
                    productId: 'PROD-001',
                    quantity: 1,
                    unitPrice: 1000,
                    totalPrice: 1000
                }],
                order: {
                    subtotal: 1000,
                    total: 1100
                }
            };

            const result = service.validateOrderData(validOrder);
            expect(result.isValid).toBe(true);
            expect(result.errors).toHaveLength(0);
        });

        test('æ‡‰è©²æª¢æ¸¬ç„¡æ•ˆçš„è¨‚å–®è³‡æ–™', () => {
            const invalidOrder = {
                orderId: '',
                customer: {
                    email: 'invalid-email'
                },
                items: [],
                order: {}
            };

            const result = service.validateOrderData(invalidOrder);
            expect(result.isValid).toBe(false);
            expect(result.errors.length).toBeGreaterThan(0);
        });
    });
});
```

#### 2. æ•´åˆæ¸¬è©¦è…³æœ¬

```javascript
// scripts/integration-test.js
const axios = require('axios');

class IntegrationTester {
    constructor(baseUrl = 'http://localhost:3000') {
        this.baseUrl = baseUrl;
    }

    async runAllTests() {
        console.log('ğŸ§ª é–‹å§‹æ•´åˆæ¸¬è©¦...');
        
        const tests = [
            this.testOrderProcessing,
            this.testDashboardAPI,
            this.testMakeBridgeAuth,
            this.testErrorHandling
        ];

        for (const test of tests) {
            try {
                await test.call(this);
                console.log(`âœ… ${test.name} é€šé`);
            } catch (error) {
                console.log(`âŒ ${test.name} å¤±æ•—:`, error.message);
            }
        }
        
        console.log('ğŸ§ª æ•´åˆæ¸¬è©¦å®Œæˆ');
    }

    async testOrderProcessing() {
        const testOrder = {
            orderId: 'ORD-TEST-001',
            customer: {
                id: 'CUST-TEST-001',
                name: 'æ¸¬è©¦å®¢æˆ¶',
                email: 'test@example.com',
                tier: 'VIP'
            },
            items: [{
                productId: 'PROD-001',
                productName: 'æ¸¬è©¦å•†å“',
                quantity: 2,
                unitPrice: 1000,
                totalPrice: 2000
            }],
            order: {
                subtotal: 2000,
                shipping: 100,
                tax: 200,
                total: 2300
            }
        };

        const response = await axios.post(`${this.baseUrl}/api/orders/process`, testOrder);
        
        if (response.status !== 200 || !response.data.success) {
            throw new Error('è¨‚å–®è™•ç† API æ¸¬è©¦å¤±æ•—');
        }
    }

    async testDashboardAPI() {
        const statsResponse = await axios.get(`${this.baseUrl}/api/dashboard/stats`);
        const ordersResponse = await axios.get(`${this.baseUrl}/api/orders/recent`);
        
        if (statsResponse.status !== 200 || ordersResponse.status !== 200) {
            throw new Error('å„€è¡¨æ¿ API æ¸¬è©¦å¤±æ•—');
        }
    }

    async testMakeBridgeAuth() {
        const response = await axios.post(`${this.baseUrl}/api/auth/token`, {
            userId: 'test@example.com'
        });
        
        if (response.status !== 200 || !response.data.token) {
            throw new Error('Make Bridge èªè­‰æ¸¬è©¦å¤±æ•—');
        }
    }

    async testErrorHandling() {
        try {
            await axios.post(`${this.baseUrl}/api/orders/process`, {});
            throw new Error('æ‡‰è©²å›å‚³éŒ¯èª¤');
        } catch (error) {
            if (error.response?.status !== 500) {
                throw new Error('éŒ¯èª¤è™•ç†æ¸¬è©¦å¤±æ•—');
            }
        }
    }
}

// åŸ·è¡Œæ¸¬è©¦
if (require.main === module) {
    const tester = new IntegrationTester();
    tester.runAllTests();
}
```

### ğŸ“Š æ•ˆèƒ½ç›£æ§

```javascript
// monitoring/performance.js
const prometheus = require('prom-client');

// å»ºç«‹ç›£æ§æŒ‡æ¨™
const httpRequestDuration = new prometheus.Histogram({
    name: 'http_request_duration_seconds',
    help: 'HTTP è«‹æ±‚è™•ç†æ™‚é–“',
    labelNames: ['method', 'route', 'status_code']
});

const orderProcessingCounter = new prometheus.Counter({
    name: 'orders_processed_total',
    help: 'å·²è™•ç†çš„è¨‚å–®ç¸½æ•¸',
    labelNames: ['priority', 'status']
});

const makeBridgeErrors = new prometheus.Counter({
    name: 'make_bridge_errors_total',
    help: 'Make Bridge éŒ¯èª¤ç¸½æ•¸',
    labelNames: ['error_type']
});

// ä¸­é–“ä»¶ï¼šè¨˜éŒ„è«‹æ±‚æ™‚é–“
function recordHttpMetrics(req, res, next) {
    const start = Date.now();
    
    res.on('finish', () => {
        const duration = (Date.now() - start) / 1000;
        httpRequestDuration
            .labels(req.method, req.route?.path || req.path, res.statusCode)
            .observe(duration);
    });
    
    next();
}

module.exports = {
    httpRequestDuration,
    orderProcessingCounter,
    makeBridgeErrors,
    recordHttpMetrics,
    register: prometheus.register
};
```

## 6.6 æœ¬ç« ç¸½çµ

å®Œæˆæœ¬ç« å¾Œï¼Œæ‚¨å·²ç¶“å»ºç«‹äº†ä¸€å€‹åŠŸèƒ½å®Œæ•´çš„ä¸­ç´šé›»å•†è¨‚å–®è¿½è¹¤ç³»çµ±ï¼ŒåŒ…æ‹¬ï¼š

âœ… **è¤‡é›œçš„ Make Bridge å·¥ä½œæµç¨‹è¨­è¨ˆ**  
âœ… **é€²éšçš„ç®¡ç†å„€è¡¨æ¿ä»‹é¢**  
âœ… **å®Œæ•´çš„å¾Œç«¯ API æœå‹™**  
âœ… **ç³»çµ±ç›£æ§å’Œæ¸¬è©¦æ©Ÿåˆ¶**  
âœ… **éŒ¯èª¤è™•ç†å’Œç•°å¸¸æ¢å¾©**  

### ğŸ“ˆ æŠ€è¡“æå‡

é€šéæœ¬é …ç›®ï¼Œæ‚¨å­¸æœƒäº†ï¼š
- è¨­è¨ˆå¤šæ¢ä»¶åˆ†æ”¯çš„è‡ªå‹•åŒ–æµç¨‹
- å»ºç«‹éŸ¿æ‡‰å¼çš„ç®¡ç†ä»‹é¢
- å¯¦ä½œè¤‡é›œçš„è³‡æ–™é©—è­‰å’Œè½‰æ›é‚è¼¯
- æ•´åˆå¤šå€‹å¤–éƒ¨ç³»çµ±å’Œ API
- å»ºç«‹ç›£æ§å’Œæ—¥èªŒç³»çµ±

### ğŸš€ ä¸‹ä¸€æ­¥

ä¸­ç´šå°ˆæ¡ˆå®Œæˆå¾Œï¼Œä¸‹ä¸€ç« å°‡å¸¶æ‚¨é€²å…¥é«˜ç´šå°ˆæ¡ˆå¯¦ä½œï¼Œå­¸ç¿’ä¼æ¥­ç´šçš„æ¶æ§‹è¨­è¨ˆå’Œå¤§è¦æ¨¡éƒ¨ç½²æŠ€å·§ã€‚