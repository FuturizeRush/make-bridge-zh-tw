# ç¬¬8ç« ï¼šå¸¸è¦‹æ‡‰ç”¨å ´æ™¯åº«

æœ¬ç« æä¾› 10+ å€‹å¯¦ç”¨çš„ Make Bridge æ‡‰ç”¨å ´æ™¯ï¼Œæ¯å€‹å ´æ™¯éƒ½åŒ…å«å®Œæ•´çš„å¯¦ä½œç¯„ä¾‹ã€æœ€ä½³å¯¦è¸å’Œå¯é‡è¤‡ä½¿ç”¨çš„ç¨‹å¼ç¢¼ç‰‡æ®µã€‚é€™äº›å ´æ™¯æ¶µè“‹äº†ä¸åŒè¡Œæ¥­å’Œæ¥­å‹™éœ€æ±‚ï¼Œå¯ä½œç‚ºæ‚¨é–‹ç™¼è‡ªå·±çš„è‡ªå‹•åŒ–è§£æ±ºæ–¹æ¡ˆçš„åƒè€ƒã€‚

## 8.1 å ´æ™¯æ¦‚è¦½

### ğŸ“‹ æ‡‰ç”¨å ´æ™¯åˆ†é¡

| å ´æ™¯é¡åˆ¥ | ä½¿ç”¨æ¡ˆä¾‹ | è¤‡é›œåº¦ | é©ç”¨å°è±¡ |
|---------|----------|--------|----------|
| **å®¢æˆ¶ç®¡ç†** | å®¢æˆ¶å›é¥‹ã€æ»¿æ„åº¦èª¿æŸ¥ã€å®¢æˆ¶åˆ†ç¾¤ | ğŸŸ¢ åˆç´š | ä¸­å°ä¼æ¥­ã€æœå‹™æ¥­ |
| **éŠ·å”®è‡ªå‹•åŒ–** | æ½›åœ¨å®¢æˆ¶ç®¡ç†ã€å ±åƒ¹æµç¨‹ã€è¨‚å–®è™•ç† | ğŸŸ¡ ä¸­ç´š | éŠ·å”®åœ˜éšŠã€é›»å•† |
| **è¡ŒéŠ·æ´»å‹•** | éƒµä»¶è¡ŒéŠ·ã€ç¤¾ç¾¤åª’é«”ã€å…§å®¹ç™¼å¸ƒ | ğŸŸ¡ ä¸­ç´š | è¡ŒéŠ·éƒ¨é–€ã€åª’é«”å…¬å¸ |
| **äººåŠ›è³‡æº** | æ‹›è˜æµç¨‹ã€å“¡å·¥å…¥è·ã€è€ƒå‹¤ç®¡ç† | ğŸŸ¡ ä¸­ç´š | HR éƒ¨é–€ã€ä¼æ¥­ç®¡ç† |
| **è²¡å‹™ç®¡ç†** | ç™¼ç¥¨è™•ç†ã€è²»ç”¨å ±éŠ·ã€è²¡å‹™å ±å‘Š | ğŸ”´ é«˜ç´š | è²¡å‹™éƒ¨é–€ã€æœƒè¨ˆå¸«äº‹å‹™æ‰€ |
| **ç‡Ÿé‹ç®¡ç†** | åº«å­˜ç®¡ç†ã€ä¾›æ‡‰éˆã€å“è³ªæ§åˆ¶ | ğŸ”´ é«˜ç´š | è£½é€ æ¥­ã€é›¶å”®æ¥­ |

### ğŸ¯ å¯¦ä½œç‰¹è‰²

æ¯å€‹å ´æ™¯åŒ…å«ï¼š
- **æ¥­å‹™éœ€æ±‚åˆ†æ**ï¼šè©³ç´°çš„ä½¿ç”¨æ¡ˆä¾‹èªªæ˜
- **Make Bridge æ¨¡æ¿è¨­è¨ˆ**ï¼šå®Œæ•´çš„å·¥ä½œæµç¨‹é…ç½®
- **å‰ç«¯æ•´åˆç¯„ä¾‹**ï¼šç”¨æˆ¶ä»‹é¢å¯¦ä½œ
- **å¾Œç«¯ API æ•´åˆ**ï¼šä¼ºæœå™¨ç«¯é‚è¼¯
- **æ¸¬è©¦å’Œéƒ¨ç½²æŒ‡å—**ï¼šå®Œæ•´çš„ä¸Šç·šæµç¨‹
- **æ“´å±•å»ºè­°**ï¼šé€²éšåŠŸèƒ½å’Œå„ªåŒ–æ–¹å‘

## 8.2 å ´æ™¯ 1ï¼šæ™ºèƒ½å®¢æœç¥¨æ“šç³»çµ±

### ğŸ“ æ¥­å‹™éœ€æ±‚

å»ºç«‹ä¸€å€‹æ™ºèƒ½å®¢æœç¥¨æ“šç³»çµ±ï¼Œç•¶å®¢æˆ¶æäº¤æ”¯æ´è«‹æ±‚æ™‚ï¼š
1. è‡ªå‹•åˆ†é¡å•é¡Œé¡å‹å’Œå„ªå…ˆç´š
2. åˆ†é…çµ¦é©ç•¶çš„å®¢æœäººå“¡
3. ç™¼é€ç¢ºèªéƒµä»¶çµ¦å®¢æˆ¶
4. å‰µå»ºå…§éƒ¨é€šçŸ¥å’Œè¿½è¹¤è¨˜éŒ„
5. æ ¹æ“šå›æ‡‰æ™‚é–“è‡ªå‹•å‡ç´š

### ğŸ”„ Make Bridge æ¨¡æ¿è¨­è¨ˆ

```javascript
// å®¢æœç¥¨æ“šå·¥ä½œæµç¨‹çµæ§‹
{
  "name": "æ™ºèƒ½å®¢æœç¥¨æ“šè™•ç†",
  "description": "è‡ªå‹•è™•ç†å®¢æˆ¶æ”¯æ´è«‹æ±‚ï¼Œåˆ†é¡ä¸¦åˆ†é…çµ¦é©ç•¶çš„å®¢æœäººå“¡",
  "modules": [
    {
      "type": "webhook",
      "name": "æ¥æ”¶æ”¯æ´è«‹æ±‚",
      "config": {
        "expectedData": {
          "customerName": "string",
          "customerEmail": "string", 
          "subject": "string",
          "description": "string",
          "priority": "low|medium|high|urgent",
          "category": "technical|billing|general|complaint",
          "attachments": "array"
        }
      }
    },
    {
      "type": "data-transformer",
      "name": "æ™ºèƒ½åˆ†é¡",
      "config": {
        "transformations": [
          {
            "field": "autoCategory",
            "logic": "analyzeKeywords({{description}}, {{subject}})"
          },
          {
            "field": "autoPriority", 
            "logic": "calculatePriority({{category}}, {{keywords}})"
          },
          {
            "field": "ticketId",
            "logic": "generateTicketId()"
          },
          {
            "field": "assignedAgent",
            "logic": "selectAgent({{autoCategory}}, {{autoPriority}})"
          }
        ]
      }
    },
    {
      "type": "router",
      "name": "å„ªå…ˆç´šè·¯ç”±",
      "routes": [
        {
          "condition": "{{autoPriority}} == 'urgent'",
          "path": "urgent_handling"
        },
        {
          "condition": "{{autoPriority}} == 'high'", 
          "path": "high_priority"
        },
        {
          "condition": "true",
          "path": "standard_process"
        }
      ]
    },
    {
      "type": "airtable",
      "name": "å‰µå»ºç¥¨æ“šè¨˜éŒ„",
      "config": {
        "operation": "create",
        "table": "Support Tickets",
        "fields": {
          "Ticket ID": "{{ticketId}}",
          "Customer Name": "{{customerName}}",
          "Customer Email": "{{customerEmail}}",
          "Subject": "{{subject}}",
          "Description": "{{description}}",
          "Category": "{{autoCategory}}",
          "Priority": "{{autoPriority}}",
          "Assigned Agent": "{{assignedAgent}}",
          "Status": "Open",
          "Created At": "{{timestamp}}"
        }
      }
    },
    {
      "type": "gmail",
      "name": "ç™¼é€ç¢ºèªéƒµä»¶",
      "config": {
        "to": "{{customerEmail}}",
        "subject": "æ”¯æ´è«‹æ±‚å·²æ”¶åˆ° - ç¥¨æ“šç·¨è™Ÿ: {{ticketId}}",
        "template": "customer_confirmation"
      }
    },
    {
      "type": "slack",
      "name": "é€šçŸ¥å®¢æœåœ˜éšŠ",
      "config": {
        "channel": "#customer-support",
        "message": {
          "blocks": [
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": `:ticket: *æ–°çš„æ”¯æ´è«‹æ±‚* \n*ç¥¨æ“š ID:* {{ticketId}}\n*å®¢æˆ¶:* {{customerName}}\n*é¡åˆ¥:* {{autoCategory}}\n*å„ªå…ˆç´š:* {{autoPriority}}\n*åˆ†é…çµ¦:* {{assignedAgent}}`
              }
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "æŸ¥çœ‹è©³æƒ…"
                  },
                  "url": "{{ticketUrl}}"
                }
              ]
            }
          ]
        }
      }
    }
  ]
}
```

### ğŸ’» å‰ç«¯æ•´åˆå¯¦ä½œ

```html
<!-- support-form.html - å®¢æœè¡¨å–®é é¢ -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æˆ¶æ”¯æ´</title>
    <link rel="stylesheet" href="support-form.css">
</head>
<body>
    <div class="support-container">
        <header class="support-header">
            <h1>ğŸ§ å®¢æˆ¶æ”¯æ´</h1>
            <p>æˆ‘å€‘å¾ˆæ¨‚æ„å”åŠ©æ‚¨è§£æ±ºå•é¡Œ</p>
        </header>

        <form id="support-form" class="support-form">
            <!-- å®¢æˆ¶è³‡è¨Š -->
            <div class="form-section">
                <h2>è¯çµ¡è³‡è¨Š</h2>
                
                <div class="form-group">
                    <label for="customerName">å§“å *</label>
                    <input type="text" id="customerName" name="customerName" required>
                </div>

                <div class="form-group">
                    <label for="customerEmail">é›»å­éƒµä»¶ *</label>
                    <input type="email" id="customerEmail" name="customerEmail" required>
                </div>
            </div>

            <!-- å•é¡Œè©³æƒ… -->
            <div class="form-section">
                <h2>å•é¡Œè©³æƒ…</h2>
                
                <div class="form-group">
                    <label for="category">å•é¡Œé¡åˆ¥ *</label>
                    <select id="category" name="category" required>
                        <option value="">è«‹é¸æ“‡...</option>
                        <option value="technical">æŠ€è¡“å•é¡Œ</option>
                        <option value="billing">å¸³å‹™å•é¡Œ</option>
                        <option value="general">ä¸€èˆ¬è©¢å•</option>
                        <option value="complaint">æŠ•è¨´å»ºè­°</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="priority">ç·Šæ€¥ç¨‹åº¦ *</label>
                    <select id="priority" name="priority" required>
                        <option value="">è«‹é¸æ“‡...</option>
                        <option value="low">ä½ - ä¸€èˆ¬è©¢å•</option>
                        <option value="medium">ä¸­ - éœ€è¦å”åŠ©</option>
                        <option value="high">é«˜ - å½±éŸ¿ä½¿ç”¨</option>
                        <option value="urgent">ç·Šæ€¥ - ç³»çµ±ç„¡æ³•ä½¿ç”¨</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="subject">å•é¡Œæ¨™é¡Œ *</label>
                    <input type="text" id="subject" name="subject" 
                           placeholder="ç°¡è¦æè¿°æ‚¨çš„å•é¡Œ" required>
                </div>

                <div class="form-group">
                    <label for="description">è©³ç´°æè¿° *</label>
                    <textarea id="description" name="description" rows="6"
                              placeholder="è«‹è©³ç´°æè¿°æ‚¨é‡åˆ°çš„å•é¡Œï¼ŒåŒ…æ‹¬éŒ¯èª¤è¨Šæ¯ã€æ“ä½œæ­¥é©Ÿç­‰" required></textarea>
                </div>

                <div class="form-group">
                    <label for="attachments">é™„ä»¶ (é¸å¡«)</label>
                    <input type="file" id="attachments" name="attachments" 
                           multiple accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx">
                    <small>æ”¯æ´æ ¼å¼ï¼šåœ–ç‰‡ã€PDFã€Word æ–‡ä»¶ï¼Œæœ€å¤§ 10MB</small>
                </div>
            </div>

            <!-- æäº¤æŒ‰éˆ• -->
            <div class="form-actions">
                <button type="submit" id="submit-btn" class="btn-primary">
                    <span class="btn-text">æäº¤æ”¯æ´è«‹æ±‚</span>
                    <span class="btn-loading" style="display: none;">æäº¤ä¸­...</span>
                </button>
            </div>
        </form>

        <!-- æˆåŠŸè¨Šæ¯ -->
        <div id="success-message" class="success-message" style="display: none;">
            <div class="success-icon">âœ…</div>
            <h2>æ”¯æ´è«‹æ±‚å·²æäº¤</h2>
            <p>æ‚¨çš„ç¥¨æ“šç·¨è™Ÿï¼š<strong id="ticket-id"></strong></p>
            <p>æˆ‘å€‘æœƒåœ¨ <span id="response-time"></span> å…§å›è¦†æ‚¨</p>
            <button onclick="resetForm()" class="btn-secondary">æäº¤æ–°çš„è«‹æ±‚</button>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="error-message" class="error-message" style="display: none;">
            <div class="error-icon">âŒ</div>
            <h2>æäº¤å¤±æ•—</h2>
            <p id="error-text"></p>
            <button onclick="hideError()" class="btn-secondary">é‡è©¦</button>
        </div>
    </div>

    <script src="support-form.js"></script>
</body>
</html>
```

```javascript
// support-form.js - å®¢æœè¡¨å–®é‚è¼¯
class SupportFormHandler {
    constructor() {
        this.form = document.getElementById('support-form');
        this.submitBtn = document.getElementById('submit-btn');
        this.isSubmitting = false;
        
        this.setupEventListeners();
        this.setupFormValidation();
    }

    setupEventListeners() {
        this.form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleSubmit();
        });

        // è‡ªå‹•åˆ†é¡å»ºè­°
        document.getElementById('description').addEventListener('input', 
            this.debounce(() => this.suggestCategory(), 500)
        );

        // å„ªå…ˆç´šè‡ªå‹•èª¿æ•´
        document.getElementById('category').addEventListener('change', 
            () => this.adjustPriority()
        );
    }

    async handleSubmit() {
        if (this.isSubmitting) return;

        try {
            const formData = this.collectFormData();
            
            if (!this.validateForm(formData)) {
                return;
            }

            this.setSubmittingState(true);
            
            const result = await this.submitSupportRequest(formData);
            
            this.showSuccess(result);
            
        } catch (error) {
            console.error('æäº¤æ”¯æ´è«‹æ±‚å¤±æ•—:', error);
            this.showError(error.message);
        } finally {
            this.setSubmittingState(false);
        }
    }

    collectFormData() {
        const formData = new FormData(this.form);
        const data = {};
        
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }

        // è™•ç†é™„ä»¶
        const attachments = document.getElementById('attachments').files;
        if (attachments.length > 0) {
            data.attachments = Array.from(attachments).map(file => ({
                name: file.name,
                size: file.size,
                type: file.type
            }));
        }

        // æ·»åŠ å…ƒæ•¸æ“š
        data.timestamp = new Date().toISOString();
        data.userAgent = navigator.userAgent;
        data.url = window.location.href;

        return data;
    }

    async submitSupportRequest(formData) {
        // å¦‚æœæœ‰é™„ä»¶ï¼Œå…ˆä¸Šå‚³
        if (formData.attachments && formData.attachments.length > 0) {
            const uploadedFiles = await this.uploadAttachments();
            formData.attachmentUrls = uploadedFiles;
        }

        const response = await fetch('/api/support/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
    }

    async uploadAttachments() {
        const files = document.getElementById('attachments').files;
        const uploadPromises = [];

        for (let file of files) {
            const formData = new FormData();
            formData.append('file', file);
            
            const uploadPromise = fetch('/api/support/upload', {
                method: 'POST',
                body: formData
            }).then(response => response.json());
            
            uploadPromises.push(uploadPromise);
        }

        return Promise.all(uploadPromises);
    }

    validateForm(data) {
        const errors = [];

        if (!data.customerName?.trim()) {
            errors.push('è«‹è¼¸å…¥å§“å');
        }

        if (!data.customerEmail?.trim()) {
            errors.push('è«‹è¼¸å…¥é›»å­éƒµä»¶');
        } else if (!this.isValidEmail(data.customerEmail)) {
            errors.push('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€');
        }

        if (!data.category) {
            errors.push('è«‹é¸æ“‡å•é¡Œé¡åˆ¥');
        }

        if (!data.priority) {
            errors.push('è«‹é¸æ“‡ç·Šæ€¥ç¨‹åº¦');
        }

        if (!data.subject?.trim()) {
            errors.push('è«‹è¼¸å…¥å•é¡Œæ¨™é¡Œ');
        }

        if (!data.description?.trim()) {
            errors.push('è«‹è©³ç´°æè¿°å•é¡Œ');
        } else if (data.description.trim().length < 10) {
            errors.push('å•é¡Œæè¿°è‡³å°‘éœ€è¦ 10 å€‹å­—å…ƒ');
        }

        if (errors.length > 0) {
            this.showValidationErrors(errors);
            return false;
        }

        return true;
    }

    suggestCategory() {
        const description = document.getElementById('description').value.toLowerCase();
        const categorySelect = document.getElementById('category');
        
        if (!categorySelect.value && description.length > 20) {
            let suggestedCategory = 'general';
            
            if (description.includes('éŒ¯èª¤') || description.includes('bug') || 
                description.includes('ç„¡æ³•') || description.includes('ç•¶æ©Ÿ')) {
                suggestedCategory = 'technical';
            } else if (description.includes('å¸³å–®') || description.includes('ä»˜æ¬¾') || 
                       description.includes('è²»ç”¨')) {
                suggestedCategory = 'billing';
            } else if (description.includes('ä¸æ»¿') || description.includes('æŠ•è¨´') || 
                       description.includes('æŠ±æ€¨')) {
                suggestedCategory = 'complaint';
            }
            
            if (suggestedCategory !== 'general') {
                categorySelect.value = suggestedCategory;
                this.highlightSuggestion(categorySelect);
            }
        }
    }

    adjustPriority() {
        const category = document.getElementById('category').value;
        const prioritySelect = document.getElementById('priority');
        
        if (!prioritySelect.value) {
            let suggestedPriority = 'medium';
            
            switch (category) {
                case 'technical':
                    suggestedPriority = 'high';
                    break;
                case 'billing':
                    suggestedPriority = 'medium';
                    break;
                case 'complaint':
                    suggestedPriority = 'high';
                    break;
                default:
                    suggestedPriority = 'low';
            }
            
            prioritySelect.value = suggestedPriority;
            this.highlightSuggestion(prioritySelect);
        }
    }

    highlightSuggestion(element) {
        element.style.backgroundColor = '#e3f2fd';
        setTimeout(() => {
            element.style.backgroundColor = '';
        }, 2000);
    }

    showSuccess(result) {
        this.form.style.display = 'none';
        const successMessage = document.getElementById('success-message');
        
        document.getElementById('ticket-id').textContent = result.ticketId;
        document.getElementById('response-time').textContent = 
            this.getResponseTime(result.priority);
        
        successMessage.style.display = 'block';
        successMessage.scrollIntoView({ behavior: 'smooth' });
    }

    getResponseTime(priority) {
        const responseTimes = {
            urgent: '2 å°æ™‚',
            high: '4 å°æ™‚',
            medium: '24 å°æ™‚',
            low: '48 å°æ™‚'
        };
        return responseTimes[priority] || '24 å°æ™‚';
    }

    showError(message) {
        document.getElementById('error-text').textContent = message;
        document.getElementById('error-message').style.display = 'block';
    }

    showValidationErrors(errors) {
        const errorMessage = `è«‹ä¿®æ­£ä»¥ä¸‹å•é¡Œï¼š\n${errors.join('\n')}`;
        alert(errorMessage);
    }

    setSubmittingState(isSubmitting) {
        this.isSubmitting = isSubmitting;
        const btnText = this.submitBtn.querySelector('.btn-text');
        const btnLoading = this.submitBtn.querySelector('.btn-loading');
        
        if (isSubmitting) {
            this.submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
        } else {
            this.submitBtn.disabled = false;
            btnText.style.display = 'inline';
            btnLoading.style.display = 'none';
        }
    }

    setupFormValidation() {
        // å³æ™‚é©—è­‰é‚è¼¯
        const inputs = this.form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('blur', () => this.validateField(input));
        });
    }

    validateField(field) {
        // å€‹åˆ¥æ¬„ä½é©—è­‰é‚è¼¯
        const value = field.value.trim();
        let isValid = true;
        let message = '';

        switch (field.name) {
            case 'customerEmail':
                if (value && !this.isValidEmail(value)) {
                    isValid = false;
                    message = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€';
                }
                break;
            case 'description':
                if (value && value.length < 10) {
                    isValid = false;
                    message = 'æè¿°è‡³å°‘éœ€è¦ 10 å€‹å­—å…ƒ';
                }
                break;
        }

        this.updateFieldValidation(field, isValid, message);
    }

    updateFieldValidation(field, isValid, message) {
        const errorElement = field.parentNode.querySelector('.field-error');
        
        if (errorElement) {
            errorElement.remove();
        }

        if (!isValid) {
            field.style.borderColor = '#f44336';
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'field-error';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
        } else {
            field.style.borderColor = '';
        }
    }

    isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
}

// å…¨åŸŸå‡½æ•¸
function resetForm() {
    document.getElementById('support-form').style.display = 'block';
    document.getElementById('success-message').style.display = 'none';
    document.getElementById('support-form').reset();
    window.scrollTo(0, 0);
}

function hideError() {
    document.getElementById('error-message').style.display = 'none';
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    new SupportFormHandler();
});
```

### ğŸ”§ å¾Œç«¯ API å¯¦ä½œ

```javascript
// api/support.js - å®¢æœ API å¾Œç«¯
const express = require('express');
const multer = require('multer');
const path = require('path');
const { v4: uuidv4 } = require('uuid');

const MakeBridgeService = require('../services/MakeBridgeService');
const TicketService = require('../services/TicketService');

const router = express.Router();

// æ–‡ä»¶ä¸Šå‚³é…ç½®
const upload = multer({
    storage: multer.diskStorage({
        destination: (req, file, cb) => {
            cb(null, 'uploads/support/');
        },
        filename: (req, file, cb) => {
            const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
            cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
        }
    }),
    limits: {
        fileSize: 10 * 1024 * 1024 // 10MB
    },
    fileFilter: (req, file, cb) => {
        const allowedTypes = /jpeg|jpg|png|gif|pdf|doc|docx/;
        const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
        const mimetype = allowedTypes.test(file.mimetype);
        
        if (mimetype && extname) {
            return cb(null, true);
        } else {
            cb(new Error('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼'));
        }
    }
});

class SupportController {
    constructor() {
        this.makeBridgeService = new MakeBridgeService();
        this.ticketService = new TicketService();
    }

    /**
     * æäº¤æ”¯æ´è«‹æ±‚
     */
    async submitSupportRequest(req, res) {
        try {
            const requestData = req.body;
            
            // é©—è­‰è«‹æ±‚è³‡æ–™
            const validation = this.validateSupportRequest(requestData);
            if (!validation.isValid) {
                return res.status(400).json({
                    error: 'è³‡æ–™é©—è­‰å¤±æ•—',
                    details: validation.errors
                });
            }

            // ç”Ÿæˆç¥¨æ“š ID
            const ticketId = this.generateTicketId();
            
            // æ™ºèƒ½åˆ†é¡å’Œå„ªå…ˆç´šåˆ¤æ–·
            const analysis = await this.analyzeRequest(requestData);
            
            // æº–å‚™ Make Bridge è³‡æ–™
            const bridgeData = {
                ...requestData,
                ticketId,
                autoCategory: analysis.category,
                autoPriority: analysis.priority,
                assignedAgent: analysis.assignedAgent,
                timestamp: new Date().toISOString(),
                analysisScore: analysis.confidence
            };

            // æäº¤åˆ° Make Bridge
            const bridgeResult = await this.makeBridgeService.triggerWorkflow({
                templateId: process.env.SUPPORT_TEMPLATE_ID,
                data: bridgeData
            });

            // æœ¬åœ°è¨˜éŒ„
            const ticket = await this.ticketService.createTicket({
                ticketId,
                ...requestData,
                ...analysis,
                makeBridgeExecutionId: bridgeResult.executionId,
                status: 'open'
            });

            // å›æ‡‰å®¢æˆ¶
            res.json({
                success: true,
                ticketId,
                priority: analysis.priority,
                estimatedResponseTime: this.getEstimatedResponseTime(analysis.priority),
                assignedTeam: analysis.team
            });

        } catch (error) {
            console.error('æäº¤æ”¯æ´è«‹æ±‚å¤±æ•—:', error);
            res.status(500).json({
                error: 'æäº¤å¤±æ•—',
                message: 'ç„¡æ³•è™•ç†æ‚¨çš„æ”¯æ´è«‹æ±‚ï¼Œè«‹ç¨å¾Œå†è©¦'
            });
        }
    }

    /**
     * ä¸Šå‚³é™„ä»¶
     */
    async uploadAttachment(req, res) {
        try {
            if (!req.file) {
                return res.status(400).json({ error: 'æ²’æœ‰é¸æ“‡æª”æ¡ˆ' });
            }

            const fileInfo = {
                originalName: req.file.originalname,
                filename: req.file.filename,
                size: req.file.size,
                mimetype: req.file.mimetype,
                url: `/uploads/support/${req.file.filename}`
            };

            res.json(fileInfo);

        } catch (error) {
            console.error('æª”æ¡ˆä¸Šå‚³å¤±æ•—:', error);
            res.status(500).json({ error: 'æª”æ¡ˆä¸Šå‚³å¤±æ•—' });
        }
    }

    /**
     * æŸ¥è©¢ç¥¨æ“šç‹€æ…‹
     */
    async getTicketStatus(req, res) {
        try {
            const { ticketId } = req.params;
            
            const ticket = await this.ticketService.getTicket(ticketId);
            
            if (!ticket) {
                return res.status(404).json({ error: 'ç¥¨æ“šä¸å­˜åœ¨' });
            }

            res.json({
                ticketId: ticket.ticketId,
                status: ticket.status,
                priority: ticket.priority,
                assignedAgent: ticket.assignedAgent,
                createdAt: ticket.createdAt,
                updatedAt: ticket.updatedAt,
                responses: ticket.responses || []
            });

        } catch (error) {
            console.error('æŸ¥è©¢ç¥¨æ“šå¤±æ•—:', error);
            res.status(500).json({ error: 'ç„¡æ³•æŸ¥è©¢ç¥¨æ“šç‹€æ…‹' });
        }
    }

    /**
     * æ™ºèƒ½åˆ†æè«‹æ±‚
     */
    async analyzeRequest(requestData) {
        const { subject, description, category, priority } = requestData;
        
        // é—œéµè©åˆ†æ
        const keywords = this.extractKeywords(subject + ' ' + description);
        
        // è‡ªå‹•åˆ†é¡
        const autoCategory = this.categorizeRequest(keywords, category);
        
        // å„ªå…ˆç´šèª¿æ•´
        const autoPriority = this.adjustPriority(keywords, priority, autoCategory);
        
        // åˆ†é…å®¢æœäººå“¡
        const assignedAgent = await this.assignAgent(autoCategory, autoPriority);
        
        // ç½®ä¿¡åº¦è¨ˆç®—
        const confidence = this.calculateConfidence(keywords, autoCategory, autoPriority);

        return {
            category: autoCategory,
            priority: autoPriority,
            assignedAgent: assignedAgent.name,
            team: assignedAgent.team,
            confidence,
            keywords
        };
    }

    extractKeywords(text) {
        const urgentKeywords = ['ç·Šæ€¥', 'ç„¡æ³•ä½¿ç”¨', 'ç•¶æ©Ÿ', 'éŒ¯èª¤', 'æ•…éšœ', 'bug'];
        const billingKeywords = ['å¸³å–®', 'ä»˜æ¬¾', 'è²»ç”¨', 'é€€æ¬¾', 'ç™¼ç¥¨'];
        const technicalKeywords = ['ç™»å…¥', 'å¯†ç¢¼', 'è¨­å®š', 'åŠŸèƒ½', 'æ“ä½œ'];
        
        const lowerText = text.toLowerCase();
        
        return {
            urgent: urgentKeywords.some(keyword => lowerText.includes(keyword)),
            billing: billingKeywords.some(keyword => lowerText.includes(keyword)),
            technical: technicalKeywords.some(keyword => lowerText.includes(keyword)),
            all: [urgentKeywords, billingKeywords, technicalKeywords]
                .flat()
                .filter(keyword => lowerText.includes(keyword))
        };
    }

    categorizeRequest(keywords, userCategory) {
        // å¦‚æœé—œéµè©åˆ†ææœ‰æ˜ç¢ºçµæœï¼Œå‰‡è¦†è“‹ä½¿ç”¨è€…é¸æ“‡
        if (keywords.billing) return 'billing';
        if (keywords.technical) return 'technical';
        
        // å¦å‰‡ä½¿ç”¨ä½¿ç”¨è€…é¸æ“‡
        return userCategory || 'general';
    }

    adjustPriority(keywords, userPriority, category) {
        // ç·Šæ€¥é—œéµè©è‡ªå‹•æå‡å„ªå…ˆç´š
        if (keywords.urgent) {
            return userPriority === 'urgent' ? 'urgent' : 'high';
        }
        
        // æ ¹æ“šé¡åˆ¥èª¿æ•´
        if (category === 'technical' && userPriority === 'low') {
            return 'medium';
        }
        
        return userPriority;
    }

    async assignAgent(category, priority) {
        const agents = {
            technical: [
                { name: 'æŠ€è¡“æ”¯æ´ - å°æ', team: 'æŠ€è¡“éƒ¨', skills: ['technical'] },
                { name: 'æŠ€è¡“æ”¯æ´ - å°ç‹', team: 'æŠ€è¡“éƒ¨', skills: ['technical'] }
            ],
            billing: [
                { name: 'å¸³å‹™å°ˆå“¡ - å°é™³', team: 'è²¡å‹™éƒ¨', skills: ['billing'] },
                { name: 'å¸³å‹™å°ˆå“¡ - å°æ—', team: 'è²¡å‹™éƒ¨', skills: ['billing'] }
            ],
            general: [
                { name: 'å®¢æœå°ˆå“¡ - å°å¼µ', team: 'å®¢æœéƒ¨', skills: ['general'] },
                { name: 'å®¢æœå°ˆå“¡ - å°åŠ‰', team: 'å®¢æœéƒ¨', skills: ['general'] }
            ]
        };

        const availableAgents = agents[category] || agents.general;
        
        // ç°¡åŒ–çš„è² è¼‰å¹³è¡¡ï¼ˆå¯¦éš›æ‡‰ç”¨å¯ä»¥æŸ¥è©¢è³‡æ–™åº«ï¼‰
        const randomIndex = Math.floor(Math.random() * availableAgents.length);
        return availableAgents[randomIndex];
    }

    calculateConfidence(keywords, category, priority) {
        let confidence = 0.5; // åŸºç¤ç½®ä¿¡åº¦
        
        // é—œéµè©åŒ¹é…å¢åŠ ç½®ä¿¡åº¦
        if (keywords.all.length > 0) {
            confidence += 0.2;
        }
        
        // é¡åˆ¥ä¸€è‡´æ€§
        if ((category === 'technical' && keywords.technical) ||
            (category === 'billing' && keywords.billing)) {
            confidence += 0.2;
        }
        
        // å„ªå…ˆç´šåˆç†æ€§
        if (keywords.urgent && priority === 'urgent') {
            confidence += 0.1;
        }
        
        return Math.min(confidence, 1.0);
    }

    validateSupportRequest(data) {
        const errors = [];
        
        if (!data.customerName?.trim()) {
            errors.push('å®¢æˆ¶å§“åæ˜¯å¿…å¡«æ¬„ä½');
        }
        
        if (!data.customerEmail?.trim()) {
            errors.push('å®¢æˆ¶éƒµä»¶æ˜¯å¿…å¡«æ¬„ä½');
        } else if (!this.isValidEmail(data.customerEmail)) {
            errors.push('å®¢æˆ¶éƒµä»¶æ ¼å¼ä¸æ­£ç¢º');
        }
        
        if (!data.subject?.trim()) {
            errors.push('å•é¡Œæ¨™é¡Œæ˜¯å¿…å¡«æ¬„ä½');
        }
        
        if (!data.description?.trim()) {
            errors.push('å•é¡Œæè¿°æ˜¯å¿…å¡«æ¬„ä½');
        } else if (data.description.trim().length < 10) {
            errors.push('å•é¡Œæè¿°è‡³å°‘éœ€è¦ 10 å€‹å­—å…ƒ');
        }
        
        if (!['technical', 'billing', 'general', 'complaint'].includes(data.category)) {
            errors.push('ç„¡æ•ˆçš„å•é¡Œé¡åˆ¥');
        }
        
        if (!['low', 'medium', 'high', 'urgent'].includes(data.priority)) {
            errors.push('ç„¡æ•ˆçš„å„ªå…ˆç´š');
        }

        return {
            isValid: errors.length === 0,
            errors
        };
    }

    generateTicketId() {
        const timestamp = Date.now().toString(36);
        const random = Math.random().toString(36).substr(2, 5);
        return `TK-${timestamp}-${random}`.toUpperCase();
    }

    getEstimatedResponseTime(priority) {
        const responseTimes = {
            urgent: '2 å°æ™‚å…§',
            high: '4 å°æ™‚å…§',
            medium: '24 å°æ™‚å…§',
            low: '48 å°æ™‚å…§'
        };
        return responseTimes[priority] || '24 å°æ™‚å…§';
    }

    isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
}

const controller = new SupportController();

// è·¯ç”±å®šç¾©
router.post('/submit', (req, res) => controller.submitSupportRequest(req, res));
router.post('/upload', upload.single('file'), (req, res) => controller.uploadAttachment(req, res));
router.get('/ticket/:ticketId', (req, res) => controller.getTicketStatus(req, res));

module.exports = router;
```

## 8.3 å ´æ™¯ 2ï¼šé›»å•†åº«å­˜é è­¦ç³»çµ±

### ğŸ“ æ¥­å‹™éœ€æ±‚

å»ºç«‹æ™ºèƒ½åº«å­˜é è­¦ç³»çµ±ï¼Œç•¶åº«å­˜ä½æ–¼è¨­å®šå€¼æ™‚ï¼š
1. è‡ªå‹•è¨ˆç®—è£œè²¨éœ€æ±‚å’Œæ™‚é–“
2. ç™¼é€é è­¦é€šçŸ¥çµ¦æ¡è³¼åœ˜éšŠ
3. æ ¹æ“šéŠ·å”®è¶¨å‹¢èª¿æ•´é è­¦é–¾å€¼
4. è‡ªå‹•ç”Ÿæˆæ¡è³¼å»ºè­°
5. è¿½è¹¤ä¾›æ‡‰å•†äº¤æœŸå’Œåƒ¹æ ¼

### ğŸ”„ Make Bridge æ¨¡æ¿è¨­è¨ˆ

```javascript
// åº«å­˜é è­¦å·¥ä½œæµç¨‹
{
  "name": "æ™ºèƒ½åº«å­˜é è­¦ç³»çµ±",
  "description": "ç›£æ§åº«å­˜æ°´ä½ï¼Œè‡ªå‹•é è­¦ä¸¦ç”Ÿæˆè£œè²¨å»ºè­°",
  "triggers": [
    {
      "type": "schedule",
      "name": "å®šæœŸåº«å­˜æª¢æŸ¥",
      "config": {
        "interval": "every 2 hours",
        "timezone": "Asia/Taipei"
      }
    },
    {
      "type": "webhook", 
      "name": "åº«å­˜ç•°å‹•è§¸ç™¼",
      "config": {
        "expectedData": {
          "productId": "string",
          "currentStock": "number",
          "operation": "sale|purchase|adjustment",
          "quantity": "number"
        }
      }
    }
  ],
  "modules": [
    {
      "type": "http",
      "name": "å–å¾—åº«å­˜è³‡æ–™",
      "config": {
        "url": "{{inventoryApiUrl}}/api/inventory/current",
        "method": "GET",
        "headers": {
          "Authorization": "Bearer {{inventoryApiKey}}"
        }
      }
    },
    {
      "type": "data-transformer",
      "name": "åº«å­˜åˆ†æ",
      "config": {
        "transformations": [
          {
            "field": "lowStockItems",
            "logic": "filterLowStock({{inventoryData}})"
          },
          {
            "field": "criticalItems", 
            "logic": "filterCriticalStock({{inventoryData}})"
          },
          {
            "field": "salesTrend",
            "logic": "analyzeSalesTrend({{productId}}, 30)"
          },
          {
            "field": "restockSuggestion",
            "logic": "calculateRestockQuantity({{currentStock}}, {{salesTrend}}, {{leadTime}})"
          }
        ]
      }
    },
    {
      "type": "router",
      "name": "é è­¦ç´šåˆ¥è·¯ç”±",
      "routes": [
        {
          "condition": "{{criticalItems.length}} > 0",
          "path": "critical_alert"
        },
        {
          "condition": "{{lowStockItems.length}} > 0",
          "path": "low_stock_alert"
        },
        {
          "condition": "true",
          "path": "normal_monitoring"
        }
      ]
    },
    {
      "type": "google-sheets",
      "name": "æ›´æ–°åº«å­˜ç›£æ§è¡¨",
      "config": {
        "operation": "update",
        "spreadsheetId": "{{monitoringSheetId}}",
        "range": "åº«å­˜ç›£æ§!A:Z",
        "values": "{{inventoryReport}}"
      }
    },
    {
      "type": "slack",
      "name": "ç·Šæ€¥åº«å­˜é è­¦",
      "config": {
        "channel": "#inventory-alerts",
        "message": {
          "blocks": [
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": ":warning: *ç·Šæ€¥åº«å­˜é è­¦* :warning:"
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*æ€¥éœ€è£œè²¨å•†å“:*\n{{#each criticalItems}}â€¢ {{name}} (å‰©é¤˜: {{currentStock}})\n{{/each}}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*é è¨ˆç¼ºè²¨æ™‚é–“:*\n{{#each criticalItems}}â€¢ {{name}}: {{stockoutDate}}\n{{/each}}"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "type": "airtable",
      "name": "å»ºç«‹æ¡è³¼éœ€æ±‚",
      "config": {
        "operation": "create",
        "table": "Purchase Requests",
        "fields": {
          "Product ID": "{{productId}}",
          "Product Name": "{{productName}}",
          "Current Stock": "{{currentStock}}",
          "Suggested Quantity": "{{restockSuggestion.quantity}}",
          "Estimated Cost": "{{restockSuggestion.cost}}",
          "Preferred Supplier": "{{restockSuggestion.supplier}}",
          "Priority": "{{priority}}",
          "Created At": "{{timestamp}}"
        }
      }
    }
  ]
}
```

### ğŸ’» åº«å­˜ç›£æ§å„€è¡¨æ¿

```javascript
// inventory-dashboard.js - åº«å­˜ç›£æ§å„€è¡¨æ¿
class InventoryDashboard {
    constructor() {
        this.inventoryData = [];
        this.alertRules = [];
        this.suppliers = [];
        
        this.initializeDashboard();
        this.setupRealTimeUpdates();
    }

    async initializeDashboard() {
        await this.loadInventoryData();
        await this.loadAlertRules();
        await this.loadSuppliers();
        
        this.renderDashboard();
        this.setupEventListeners();
    }

    async loadInventoryData() {
        try {
            const response = await fetch('/api/inventory/current');
            this.inventoryData = await response.json();
        } catch (error) {
            console.error('è¼‰å…¥åº«å­˜è³‡æ–™å¤±æ•—:', error);
        }
    }

    renderDashboard() {
        const dashboard = document.getElementById('inventory-dashboard');
        
        dashboard.innerHTML = `
            <div class="dashboard-header">
                <h1>ğŸ“¦ åº«å­˜ç›£æ§ä¸­å¿ƒ</h1>
                <div class="dashboard-stats">
                    ${this.renderStatsCards()}
                </div>
            </div>
            
            <div class="dashboard-content">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h2>åº«å­˜é è­¦</h2>
                        ${this.renderAlerts()}
                    </div>
                    
                    <div class="dashboard-card">
                        <h2>è£œè²¨å»ºè­°</h2>
                        ${this.renderRestockSuggestions()}
                    </div>
                    
                    <div class="dashboard-card">
                        <h2>éŠ·å”®è¶¨å‹¢</h2>
                        ${this.renderSalesTrends()}
                    </div>
                    
                    <div class="dashboard-card">
                        <h2>ä¾›æ‡‰å•†ç‹€æ…‹</h2>
                        ${this.renderSupplierStatus()}
                    </div>
                </div>
            </div>
        `;
    }

    renderStatsCards() {
        const lowStockCount = this.inventoryData.filter(item => 
            item.currentStock <= item.lowStockThreshold).length;
        
        const outOfStockCount = this.inventoryData.filter(item => 
            item.currentStock <= 0).length;
        
        const totalValue = this.inventoryData.reduce((sum, item) => 
            sum + (item.currentStock * item.unitCost), 0);

        return `
            <div class="stat-card">
                <div class="stat-icon">ğŸ“‹</div>
                <div class="stat-content">
                    <div class="stat-value">${this.inventoryData.length}</div>
                    <div class="stat-label">ç¸½å•†å“æ•¸</div>
                </div>
            </div>
            
            <div class="stat-card alert">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-content">
                    <div class="stat-value">${lowStockCount}</div>
                    <div class="stat-label">ä½åº«å­˜é è­¦</div>
                </div>
            </div>
            
            <div class="stat-card critical">
                <div class="stat-icon">ğŸš¨</div>
                <div class="stat-content">
                    <div class="stat-value">${outOfStockCount}</div>
                    <div class="stat-label">ç¼ºè²¨å•†å“</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-content">
                    <div class="stat-value">${this.formatCurrency(totalValue)}</div>
                    <div class="stat-label">åº«å­˜ç¸½å€¼</div>
                </div>
            </div>
        `;
    }

    renderAlerts() {
        const alerts = this.generateAlerts();
        
        if (alerts.length === 0) {
            return '<p class="no-alerts">æš«ç„¡åº«å­˜é è­¦</p>';
        }

        return `
            <div class="alerts-list">
                ${alerts.map(alert => `
                    <div class="alert-item ${alert.severity}">
                        <div class="alert-icon">${alert.icon}</div>
                        <div class="alert-content">
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-description">${alert.description}</div>
                            <div class="alert-actions">
                                <button onclick="this.handleRestockNow('${alert.productId}')" 
                                        class="btn btn-sm btn-primary">
                                    ç«‹å³è£œè²¨
                                </button>
                                <button onclick="this.handleAdjustThreshold('${alert.productId}')" 
                                        class="btn btn-sm btn-secondary">
                                    èª¿æ•´é–¾å€¼
                                </button>
                            </div>
                        </div>
                        <div class="alert-timestamp">${alert.timestamp}</div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    generateAlerts() {
        const alerts = [];
        
        this.inventoryData.forEach(item => {
            // ç¼ºè²¨è­¦å ±
            if (item.currentStock <= 0) {
                alerts.push({
                    productId: item.productId,
                    severity: 'critical',
                    icon: 'ğŸš¨',
                    title: `${item.productName} å·²ç¼ºè²¨`,
                    description: `ç•¶å‰åº«å­˜: ${item.currentStock}ï¼Œæ€¥éœ€è£œè²¨`,
                    timestamp: this.getTimeAgo(item.lastUpdated)
                });
            }
            // ä½åº«å­˜è­¦å ±
            else if (item.currentStock <= item.lowStockThreshold) {
                const daysUntilStockout = this.calculateDaysUntilStockout(item);
                alerts.push({
                    productId: item.productId,
                    severity: 'warning',
                    icon: 'âš ï¸',
                    title: `${item.productName} åº«å­˜åä½`,
                    description: `ç•¶å‰åº«å­˜: ${item.currentStock}ï¼Œé è¨ˆ ${daysUntilStockout} å¤©å¾Œç¼ºè²¨`,
                    timestamp: this.getTimeAgo(item.lastUpdated)
                });
            }
        });

        return alerts.sort((a, b) => {
            const severityOrder = { critical: 0, warning: 1, info: 2 };
            return severityOrder[a.severity] - severityOrder[b.severity];
        });
    }

    calculateDaysUntilStockout(item) {
        // æ ¹æ“šæ­·å²éŠ·å”®è³‡æ–™è¨ˆç®—é è¨ˆç¼ºè²¨æ™‚é–“
        const dailySalesRate = item.averageDailySales || 1;
        return Math.floor(item.currentStock / dailySalesRate);
    }

    async handleRestockNow(productId) {
        try {
            const product = this.inventoryData.find(item => item.productId === productId);
            
            // è¨ˆç®—å»ºè­°è£œè²¨é‡
            const suggestion = await this.calculateRestockSuggestion(product);
            
            // é¡¯ç¤ºè£œè²¨å°è©±æ¡†
            this.showRestockDialog(product, suggestion);
            
        } catch (error) {
            console.error('è™•ç†è£œè²¨è«‹æ±‚å¤±æ•—:', error);
            alert('ç„¡æ³•è™•ç†è£œè²¨è«‹æ±‚ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
    }

    async calculateRestockSuggestion(product) {
        // åˆ†æéŠ·å”®è¶¨å‹¢
        const salesHistory = await this.getSalesHistory(product.productId, 30);
        
        // è¨ˆç®—å¹³å‡æ—¥éŠ·é‡
        const averageDailySales = salesHistory.reduce((sum, day) => sum + day.quantity, 0) / 30;
        
        // è€ƒæ…®ä¾›æ‡‰å•†äº¤æœŸ
        const leadTime = product.supplier?.leadTimeDays || 7;
        
        // å®‰å…¨åº«å­˜ä¿‚æ•¸
        const safetyFactor = 1.5;
        
        // å»ºè­°è£œè²¨é‡ = (æ—¥éŠ·é‡ Ã— äº¤æœŸ Ã— å®‰å…¨ä¿‚æ•¸) + ç›®æ¨™åº«å­˜ - ç•¶å‰åº«å­˜
        const suggestedQuantity = Math.ceil(
            (averageDailySales * leadTime * safetyFactor) + 
            product.optimalStock - 
            product.currentStock
        );

        return {
            quantity: Math.max(suggestedQuantity, product.minimumOrderQuantity || 1),
            estimatedCost: suggestedQuantity * product.unitCost,
            supplier: product.supplier,
            expectedDelivery: this.addDays(new Date(), leadTime),
            reasoning: {
                averageDailySales,
                leadTime,
                safetyFactor,
                currentStock: product.currentStock,
                targetStock: product.optimalStock
            }
        };
    }

    showRestockDialog(product, suggestion) {
        const dialog = document.createElement('div');
        dialog.className = 'restock-dialog-overlay';
        dialog.innerHTML = `
            <div class="restock-dialog">
                <div class="dialog-header">
                    <h3>è£œè²¨å»ºè­° - ${product.productName}</h3>
                    <button class="close-btn" onclick="this.closeRestockDialog()">&times;</button>
                </div>
                
                <div class="dialog-content">
                    <div class="product-info">
                        <p><strong>ç•¶å‰åº«å­˜:</strong> ${product.currentStock}</p>
                        <p><strong>ç›®æ¨™åº«å­˜:</strong> ${product.optimalStock}</p>
                        <p><strong>å¹³å‡æ—¥éŠ·:</strong> ${suggestion.reasoning.averageDailySales.toFixed(1)}</p>
                    </div>
                    
                    <div class="suggestion-info">
                        <p><strong>å»ºè­°è£œè²¨é‡:</strong> ${suggestion.quantity}</p>
                        <p><strong>é ä¼°æˆæœ¬:</strong> ${this.formatCurrency(suggestion.estimatedCost)}</p>
                        <p><strong>ä¾›æ‡‰å•†:</strong> ${suggestion.supplier?.name || 'æœªæŒ‡å®š'}</p>
                        <p><strong>é è¨ˆåˆ°è²¨:</strong> ${this.formatDate(suggestion.expectedDelivery)}</p>
                    </div>
                    
                    <div class="custom-quantity">
                        <label for="customQuantity">è‡ªè¨‚è£œè²¨é‡:</label>
                        <input type="number" id="customQuantity" value="${suggestion.quantity}" min="1">
                    </div>
                </div>
                
                <div class="dialog-actions">
                    <button class="btn btn-secondary" onclick="this.closeRestockDialog()">
                        å–æ¶ˆ
                    </button>
                    <button class="btn btn-primary" onclick="this.submitRestockRequest('${product.productId}')">
                        æäº¤è£œè²¨è«‹æ±‚
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
    }

    async submitRestockRequest(productId) {
        try {
            const quantity = document.getElementById('customQuantity').value;
            
            const requestData = {
                productId,
                quantity: parseInt(quantity),
                reason: 'low_stock_alert',
                requestedBy: 'inventory_system',
                timestamp: new Date().toISOString()
            };

            // æäº¤åˆ° Make Bridge
            const response = await fetch('/api/inventory/restock-request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            if (response.ok) {
                alert('è£œè²¨è«‹æ±‚å·²æäº¤');
                this.closeRestockDialog();
                this.refreshDashboard();
            } else {
                throw new Error('æäº¤å¤±æ•—');
            }

        } catch (error) {
            console.error('æäº¤è£œè²¨è«‹æ±‚å¤±æ•—:', error);
            alert('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
    }

    closeRestockDialog() {
        const dialog = document.querySelector('.restock-dialog-overlay');
        if (dialog) {
            dialog.remove();
        }
    }

    setupRealTimeUpdates() {
        // ä½¿ç”¨ WebSocket æˆ– Server-Sent Events é€²è¡Œå³æ™‚æ›´æ–°
        if ('WebSocket' in window) {
            this.connectWebSocket();
        } else {
            // å›é€€åˆ°å®šæœŸè¼ªè©¢
            setInterval(() => this.refreshDashboard(), 30000);
        }
    }

    connectWebSocket() {
        const ws = new WebSocket(`ws://${window.location.host}/ws/inventory`);
        
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.handleRealTimeUpdate(data);
        };
        
        ws.onclose = () => {
            console.log('WebSocket é€£æ¥é—œé–‰ï¼Œ5ç§’å¾Œé‡æ–°é€£æ¥');
            setTimeout(() => this.connectWebSocket(), 5000);
        };
    }

    handleRealTimeUpdate(data) {
        switch (data.type) {
            case 'inventory_update':
                this.updateInventoryItem(data.productId, data.newStock);
                break;
            case 'new_alert':
                this.addNewAlert(data.alert);
                break;
            case 'restock_completed':
                this.handleRestockCompleted(data.productId, data.quantity);
                break;
        }
    }

    updateInventoryItem(productId, newStock) {
        const item = this.inventoryData.find(item => item.productId === productId);
        if (item) {
            item.currentStock = newStock;
            item.lastUpdated = new Date().toISOString();
            this.renderDashboard();
        }
    }

    // å·¥å…·å‡½æ•¸
    formatCurrency(amount) {
        return new Intl.NumberFormat('zh-TW', {
            style: 'currency',
            currency: 'TWD'
        }).format(amount);
    }

    formatDate(date) {
        return new Intl.DateTimeFormat('zh-TW').format(new Date(date));
    }

    getTimeAgo(timestamp) {
        const now = new Date();
        const past = new Date(timestamp);
        const diffInMinutes = Math.floor((now - past) / 60000);
        
        if (diffInMinutes < 60) {
            return `${diffInMinutes} åˆ†é˜å‰`;
        } else if (diffInMinutes < 1440) {
            return `${Math.floor(diffInMinutes / 60)} å°æ™‚å‰`;
        } else {
            return `${Math.floor(diffInMinutes / 1440)} å¤©å‰`;
        }
    }

    addDays(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    }
}

// åˆå§‹åŒ–å„€è¡¨æ¿
document.addEventListener('DOMContentLoaded', () => {
    new InventoryDashboard();
});
```

## 8.4 å ´æ™¯ 3ï¼šå“¡å·¥å…¥è·è‡ªå‹•åŒ–æµç¨‹

### ğŸ“ æ¥­å‹™éœ€æ±‚

å»ºç«‹å®Œæ•´çš„æ–°å“¡å·¥å…¥è·è‡ªå‹•åŒ–ç³»çµ±ï¼š
1. è‡ªå‹•å»ºç«‹å„ç³»çµ±å¸³æˆ¶å’Œæ¬Šé™
2. å®‰æ’å…¥è·è¨“ç·´èª²ç¨‹å’Œæœƒè­°
3. æº–å‚™è¾¦å…¬è¨­å‚™å’Œå·¥ä½œç©ºé–“
4. ç™¼é€æ­¡è¿éƒµä»¶å’Œå…¥è·æŒ‡å—
5. è¿½è¹¤å…¥è·é€²åº¦å’Œå®Œæˆç‹€æ³

### ğŸ”„ Make Bridge æ¨¡æ¿è¨­è¨ˆ

```javascript
// å“¡å·¥å…¥è·è‡ªå‹•åŒ–æµç¨‹
{
  "name": "æ–°å“¡å·¥å…¥è·è‡ªå‹•åŒ–",
  "description": "è‡ªå‹•åŒ–æ–°å“¡å·¥å…¥è·æµç¨‹ï¼Œå¾å¸³æˆ¶å‰µå»ºåˆ°åŸ¹è¨“å®‰æ’",
  "modules": [
    {
      "type": "webhook",
      "name": "æ–°å“¡å·¥è³‡æ–™æ¥æ”¶",
      "config": {
        "expectedData": {
          "employeeId": "string",
          "fullName": "string",
          "email": "string",
          "department": "string",
          "position": "string",
          "manager": "string",
          "startDate": "date",
          "employmentType": "full-time|part-time|contract",
          "location": "string"
        }
      }
    },
    {
      "type": "data-transformer",
      "name": "å…¥è·è³‡æ–™è™•ç†",
      "config": {
        "transformations": [
          {
            "field": "username",
            "logic": "generateUsername({{fullName}}, {{employeeId}})"
          },
          {
            "field": "temporaryPassword",
            "logic": "generateSecurePassword()"
          },
          {
            "field": "requiredSystems",
            "logic": "getSystemsByDepartment({{department}}, {{position}})"
          },
          {
            "field": "trainingModules",
            "logic": "getRequiredTraining({{department}}, {{position}})"
          },
          {
            "field": "equipmentNeeds",
            "logic": "getEquipmentList({{position}}, {{location}})"
          }
        ]
      }
    },
    {
      "type": "parallel",
      "name": "ä¸¦è¡Œè™•ç†å…¥è·ä»»å‹™",
      "branches": [
        {
          "name": "ç³»çµ±å¸³æˆ¶å‰µå»º",
          "modules": [
            {
              "type": "http",
              "name": "å‰µå»º AD å¸³æˆ¶",
              "config": {
                "url": "{{adApiUrl}}/api/users",
                "method": "POST",
                "body": {
                  "username": "{{username}}",
                  "fullName": "{{fullName}}",
                  "email": "{{email}}",
                  "department": "{{department}}",
                  "temporaryPassword": "{{temporaryPassword}}"
                }
              }
            },
            {
              "type": "http",
              "name": "å‰µå»º Google Workspace å¸³æˆ¶",
              "config": {
                "url": "{{googleApiUrl}}/admin/directory/v1/users",
                "method": "POST",
                "headers": {
                  "Authorization": "Bearer {{googleAccessToken}}"
                },
                "body": {
                  "primaryEmail": "{{email}}",
                  "name": {
                    "fullName": "{{fullName}}"
                  },
                  "password": "{{temporaryPassword}}",
                  "orgUnitPath": "/{{department}}"
                }
              }
            },
            {
              "type": "http",
              "name": "åˆ†é…ç³»çµ±æ¬Šé™",
              "config": {
                "url": "{{permissionApiUrl}}/api/permissions/assign",
                "method": "POST",
                "body": {
                  "userId": "{{username}}",
                  "systems": "{{requiredSystems}}",
                  "department": "{{department}}",
                  "position": "{{position}}"
                }
              }
            }
          ]
        },
        {
          "name": "è¨­å‚™å’Œç©ºé–“æº–å‚™",
          "modules": [
            {
              "type": "airtable",
              "name": "å»ºç«‹è¨­å‚™è«‹æ±‚",
              "config": {
                "operation": "create",
                "table": "Equipment Requests",
                "fields": {
                  "Employee ID": "{{employeeId}}",
                  "Employee Name": "{{fullName}}",
                  "Department": "{{department}}",
                  "Equipment List": "{{equipmentNeeds}}",
                  "Location": "{{location}}",
                  "Required Date": "{{startDate}}",
                  "Status": "Pending"
                }
              }
            },
            {
              "type": "http",
              "name": "åˆ†é…è¾¦å…¬åº§ä½",
              "config": {
                "url": "{{facilityApiUrl}}/api/seating/assign",
                "method": "POST",
                "body": {
                  "employeeId": "{{employeeId}}",
                  "department": "{{department}}",
                  "location": "{{location}}",
                  "startDate": "{{startDate}}"
                }
              }
            }
          ]
        },
        {
          "name": "åŸ¹è¨“å®‰æ’",
          "modules": [
            {
              "type": "http",
              "name": "è¨»å†ŠåŸ¹è¨“èª²ç¨‹",
              "config": {
                "url": "{{lmsApiUrl}}/api/enrollments",
                "method": "POST",
                "body": {
                  "employeeId": "{{employeeId}}",
                  "courses": "{{trainingModules}}",
                  "startDate": "{{startDate}}"
                }
              }
            },
            {
              "type": "google-calendar",
              "name": "å®‰æ’å…¥è·æœƒè­°",
              "config": {
                "operation": "create",
                "calendarId": "{{hrCalendarId}}",
                "event": {
                  "summary": "æ–°å“¡å·¥å…¥è·æœƒè­° - {{fullName}}",
                  "description": "æ­¡è¿æ–°åŒäº‹ {{fullName}} åŠ å…¥ {{department}}",
                  "start": {
                    "dateTime": "{{startDate}}T09:00:00",
                    "timeZone": "Asia/Taipei"
                  },
                  "end": {
                    "dateTime": "{{startDate}}T10:00:00",
                    "timeZone": "Asia/Taipei"
                  },
                  "attendees": [
                    {"email": "{{email}}"},
                    {"email": "{{manager}}"},
                    {"email": "hr@company.com"}
                  ]
                }
              }
            }
          ]
        }
      ]
    },
    {
      "type": "delay",
      "name": "ç­‰å¾…ä¸¦è¡Œä»»å‹™å®Œæˆ",
      "config": {
        "delay": 30,
        "unit": "seconds"
      }
    },
    {
      "type": "gmail",
      "name": "ç™¼é€æ­¡è¿éƒµä»¶",
      "config": {
        "to": "{{email}}",
        "cc": "{{manager}}, hr@company.com",
        "subject": "æ­¡è¿åŠ å…¥å…¬å¸ï¼æ‚¨çš„å…¥è·è³‡è¨Š - {{fullName}}",
        "template": "welcome_email",
        "templateData": {
          "fullName": "{{fullName}}",
          "department": "{{department}}",
          "position": "{{position}}",
          "manager": "{{manager}}",
          "startDate": "{{startDate}}",
          "username": "{{username}}",
          "temporaryPassword": "{{temporaryPassword}}",
          "trainingModules": "{{trainingModules}}",
          "firstDaySchedule": "{{firstDaySchedule}}"
        }
      }
    },
    {
      "type": "slack",
      "name": "é€šçŸ¥åœ˜éšŠ",
      "config": {
        "channel": "#general",
        "message": {
          "blocks": [
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": ":wave: æ­¡è¿æ–°åŒäº‹ *{{fullName}}* åŠ å…¥æˆ‘å€‘ï¼"
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*éƒ¨é–€:* {{department}}"
                },
                {
                  "type": "mrkdwn", 
                  "text": "*è·ä½:* {{position}}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*é–‹å§‹æ—¥æœŸ:* {{startDate}}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*ä¸»ç®¡:* {{manager}}"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "type": "airtable",
      "name": "å»ºç«‹å…¥è·è¿½è¹¤è¨˜éŒ„",
      "config": {
        "operation": "create",
        "table": "Onboarding Tracker",
        "fields": {
          "Employee ID": "{{employeeId}}",
          "Full Name": "{{fullName}}",
          "Department": "{{department}}",
          "Start Date": "{{startDate}}",
          "Account Created": "Yes",
          "Equipment Requested": "Yes",
          "Training Enrolled": "Yes",
          "Welcome Email Sent": "Yes",
          "Status": "In Progress",
          "Created At": "{{timestamp}}"
        }
      }
    }
  ]
}
```

### ğŸ’» HR ç®¡ç†ä»‹é¢

```javascript
// hr-onboarding.js - HR å…¥è·ç®¡ç†ç³»çµ±
class OnboardingManagement {
    constructor() {
        this.employees = [];
        this.templates = [];
        this.onboardingTasks = [];
        
        this.initializeSystem();
    }

    async initializeSystem() {
        await this.loadEmployees();
        await this.loadTemplates();
        await this.loadOnboardingTasks();
        
        this.renderInterface();
        this.setupEventListeners();
    }

    renderInterface() {
        const container = document.getElementById('onboarding-management');
        
        container.innerHTML = `
            <div class="onboarding-header">
                <h1>ğŸ‘‹ å“¡å·¥å…¥è·ç®¡ç†</h1>
                <button class="btn btn-primary" onclick="this.showNewEmployeeForm()">
                    <i class="fas fa-plus"></i> æ–°å¢å“¡å·¥
                </button>
            </div>
            
            <div class="onboarding-tabs">
                <button class="tab-btn active" data-tab="dashboard">å„€è¡¨æ¿</button>
                <button class="tab-btn" data-tab="employees">å“¡å·¥åˆ—è¡¨</button>
                <button class="tab-btn" data-tab="tasks">ä»»å‹™è¿½è¹¤</button>
                <button class="tab-btn" data-tab="templates">ç¯„æœ¬ç®¡ç†</button>
            </div>
            
            <div class="tab-content">
                <div id="dashboard-tab" class="tab-pane active">
                    ${this.renderDashboard()}
                </div>
                
                <div id="employees-tab" class="tab-pane">
                    ${this.renderEmployeesList()}
                </div>
                
                <div id="tasks-tab" class="tab-pane">
                    ${this.renderTasksTracker()}
                </div>
                
                <div id="templates-tab" class="tab-pane">
                    ${this.renderTemplatesManager()}
                </div>
            </div>
        `;
    }

    renderDashboard() {
        const today = new Date();
        const thisWeek = this.getThisWeekEmployees();
        const thisMonth = this.getThisMonthEmployees();
        const pending = this.getPendingTasks();

        return `
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-content">
                        <div class="stat-value">${thisWeek.length}</div>
                        <div class="stat-label">æœ¬é€±å…¥è·</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“…</div>
                    <div class="stat-content">
                        <div class="stat-value">${thisMonth.length}</div>
                        <div class="stat-label">æœ¬æœˆå…¥è·</div>
                    </div>
                </div>
                
                <div class="stat-card alert">
                    <div class="stat-icon">â³</div>
                    <div class="stat-content">
                        <div class="stat-value">${pending.length}</div>
                        <div class="stat-label">å¾…å®Œæˆä»»å‹™</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-content">
                        <div class="stat-value">${this.getCompletionRate()}%</div>
                        <div class="stat-label">å®Œæˆç‡</div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-content">
                <div class="dashboard-section">
                    <h3>å³å°‡å…¥è·å“¡å·¥</h3>
                    ${this.renderUpcomingEmployees()}
                </div>
                
                <div class="dashboard-section">
                    <h3>å¾…è™•ç†ä»»å‹™</h3>
                    ${this.renderPendingTasks()}
                </div>
            </div>
        `;
    }

    showNewEmployeeForm() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3>æ–°å¢å“¡å·¥</h3>
                    <button class="close-btn" onclick="this.closeModal()">&times;</button>
                </div>
                
                <form id="new-employee-form" class="modal-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="employeeId">å“¡å·¥ç·¨è™Ÿ *</label>
                            <input type="text" id="employeeId" name="employeeId" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="fullName">å§“å *</label>
                            <input type="text" id="fullName" name="fullName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="email">å…¬å¸éƒµä»¶ *</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="department">éƒ¨é–€ *</label>
                            <select id="department" name="department" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="engineering">æŠ€è¡“éƒ¨</option>
                                <option value="marketing">è¡ŒéŠ·éƒ¨</option>
                                <option value="sales">æ¥­å‹™éƒ¨</option>
                                <option value="hr">äººè³‡éƒ¨</option>
                                <option value="finance">è²¡å‹™éƒ¨</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="position">è·ä½ *</label>
                            <input type="text" id="position" name="position" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="manager">ç›´å±¬ä¸»ç®¡éƒµä»¶ *</label>
                            <input type="email" id="manager" name="manager" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="startDate">å…¥è·æ—¥æœŸ *</label>
                            <input type="date" id="startDate" name="startDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="employmentType">è˜ç”¨é¡å‹ *</label>
                            <select id="employmentType" name="employmentType" required>
                                <option value="full-time">æ­£è·</option>
                                <option value="part-time">å…¼è·</option>
                                <option value="contract">ç´„è˜</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="location">å·¥ä½œåœ°é» *</label>
                            <select id="location" name="location" required>
                                <option value="taipei">å°åŒ—ç¸½éƒ¨</option>
                                <option value="taichung">å°ä¸­åˆ†å…¬å¸</option>
                                <option value="kaohsiung">é«˜é›„åˆ†å…¬å¸</option>
                                <option value="remote">é ç«¯å·¥ä½œ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>ç‰¹æ®Šéœ€æ±‚ (é¸å¡«)</h4>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="needs" value="accessibility"> ç„¡éšœç¤™è¨­æ–½</label>
                            <label><input type="checkbox" name="needs" value="mac"> Mac é›»è…¦</label>
                            <label><input type="checkbox" name="needs" value="monitor"> å¤–æ¥è¢å¹•</label>
                            <label><input type="checkbox" name="needs" value="parking"> åœè»Šä½</label>
                        </div>
                    </div>
                </form>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="this.closeModal()">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" form="new-employee-form" class="btn btn-primary">
                        é–‹å§‹å…¥è·æµç¨‹
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // è¨­å®šè¡¨å–®æäº¤è™•ç†
        document.getElementById('new-employee-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleNewEmployeeSubmit(e.target);
        });
    }

    async handleNewEmployeeSubmit(form) {
        try {
            const formData = new FormData(form);
            const employeeData = {};
            
            // æ”¶é›†åŸºæœ¬è³‡æ–™
            for (let [key, value] of formData.entries()) {
                if (key === 'needs') {
                    if (!employeeData.specialNeeds) employeeData.specialNeeds = [];
                    employeeData.specialNeeds.push(value);
                } else {
                    employeeData[key] = value;
                }
            }

            // é©—è­‰è³‡æ–™
            if (!this.validateEmployeeData(employeeData)) {
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            this.showLoadingState();

            // æäº¤åˆ° Make Bridge
            const result = await this.submitOnboardingRequest(employeeData);

            // æˆåŠŸè™•ç†
            this.showSuccessMessage(result);
            this.closeModal();
            this.refreshEmployeesList();

        } catch (error) {
            console.error('æäº¤å…¥è·æµç¨‹å¤±æ•—:', error);
            this.showErrorMessage(error.message);
        }
    }

    async submitOnboardingRequest(employeeData) {
        const response = await fetch('/api/onboarding/initiate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(employeeData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'æäº¤å¤±æ•—');
        }

        return response.json();
    }

    validateEmployeeData(data) {
        const errors = [];
        
        if (!data.employeeId?.trim()) errors.push('å“¡å·¥ç·¨è™Ÿç‚ºå¿…å¡«');
        if (!data.fullName?.trim()) errors.push('å§“åç‚ºå¿…å¡«');
        if (!data.email?.trim()) errors.push('éƒµä»¶ç‚ºå¿…å¡«');
        if (!data.department) errors.push('éƒ¨é–€ç‚ºå¿…å¡«');
        if (!data.position?.trim()) errors.push('è·ä½ç‚ºå¿…å¡«');
        if (!data.manager?.trim()) errors.push('ä¸»ç®¡éƒµä»¶ç‚ºå¿…å¡«');
        if (!data.startDate) errors.push('å…¥è·æ—¥æœŸç‚ºå¿…å¡«');

        // æª¢æŸ¥æ—¥æœŸæ˜¯å¦ç‚ºæœªä¾†æ—¥æœŸ
        if (data.startDate && new Date(data.startDate) < new Date()) {
            errors.push('å…¥è·æ—¥æœŸä¸èƒ½æ˜¯éå»çš„æ—¥æœŸ');
        }

        // æª¢æŸ¥éƒµä»¶æ ¼å¼
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (data.email && !emailRegex.test(data.email)) {
            errors.push('éƒµä»¶æ ¼å¼ä¸æ­£ç¢º');
        }
        if (data.manager && !emailRegex.test(data.manager)) {
            errors.push('ä¸»ç®¡éƒµä»¶æ ¼å¼ä¸æ­£ç¢º');
        }

        if (errors.length > 0) {
            alert('è«‹ä¿®æ­£ä»¥ä¸‹å•é¡Œï¼š\n' + errors.join('\n'));
            return false;
        }

        return true;
    }

    renderTasksTracker() {
        return `
            <div class="tasks-tracker">
                <div class="tracker-filters">
                    <select id="employee-filter">
                        <option value="">æ‰€æœ‰å“¡å·¥</option>
                        ${this.employees.map(emp => 
                            `<option value="${emp.employeeId}">${emp.fullName}</option>`
                        ).join('')}
                    </select>
                    
                    <select id="status-filter">
                        <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                        <option value="pending">å¾…è™•ç†</option>
                        <option value="in-progress">é€²è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="overdue">é€¾æœŸ</option>
                    </select>
                </div>
                
                <div class="tasks-list">
                    ${this.renderTasksList()}
                </div>
            </div>
        `;
    }

    renderTasksList() {
        return this.onboardingTasks.map(task => `
            <div class="task-item ${task.status}">
                <div class="task-header">
                    <div class="task-employee">
                        <strong>${task.employeeName}</strong>
                        <span class="employee-id">(${task.employeeId})</span>
                    </div>
                    <div class="task-status">
                        <span class="status-badge ${task.status}">${this.getStatusText(task.status)}</span>
                    </div>
                </div>
                
                <div class="task-content">
                    <div class="task-title">${task.title}</div>
                    <div class="task-description">${task.description}</div>
                    
                    <div class="task-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${task.progress}%"></div>
                        </div>
                        <span class="progress-text">${task.progress}% å®Œæˆ</span>
                    </div>
                    
                    <div class="task-dates">
                        <span>é–‹å§‹ï¼š${this.formatDate(task.startDate)}</span>
                        <span>é è¨ˆå®Œæˆï¼š${this.formatDate(task.dueDate)}</span>
                    </div>
                </div>
                
                <div class="task-actions">
                    <button class="btn btn-sm btn-outline" onclick="this.viewTaskDetails('${task.id}')">
                        æŸ¥çœ‹è©³æƒ…
                    </button>
                    ${task.status === 'pending' ? 
                        `<button class="btn btn-sm btn-primary" onclick="this.startTask('${task.id}')">
                            é–‹å§‹è™•ç†
                        </button>` : ''
                    }
                    ${task.status === 'in-progress' ? 
                        `<button class="btn btn-sm btn-success" onclick="this.completeTask('${task.id}')">
                            æ¨™è¨˜å®Œæˆ
                        </button>` : ''
                    }
                </div>
            </div>
        `).join('');
    }

    // å·¥å…·å‡½æ•¸
    getThisWeekEmployees() {
        const today = new Date();
        const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
        const weekEnd = new Date(today.setDate(today.getDate() - today.getDay() + 6));
        
        return this.employees.filter(emp => {
            const startDate = new Date(emp.startDate);
            return startDate >= weekStart && startDate <= weekEnd;
        });
    }

    getThisMonthEmployees() {
        const today = new Date();
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        return this.employees.filter(emp => {
            const startDate = new Date(emp.startDate);
            return startDate >= monthStart && startDate <= monthEnd;
        });
    }

    getPendingTasks() {
        return this.onboardingTasks.filter(task => 
            task.status === 'pending' || task.status === 'overdue'
        );
    }

    getCompletionRate() {
        const total = this.onboardingTasks.length;
        const completed = this.onboardingTasks.filter(task => task.status === 'completed').length;
        return total > 0 ? Math.round((completed / total) * 100) : 0;
    }

    formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('zh-TW');
    }

    getStatusText(status) {
        const statusMap = {
            'pending': 'å¾…è™•ç†',
            'in-progress': 'é€²è¡Œä¸­',
            'completed': 'å·²å®Œæˆ',
            'overdue': 'é€¾æœŸ'
        };
        return statusMap[status] || status;
    }

    closeModal() {
        const modal = document.querySelector('.modal-overlay');
        if (modal) {
            modal.remove();
        }
    }

    showLoadingState() {
        // å¯¦ä½œè¼‰å…¥ç‹€æ…‹é¡¯ç¤º
    }

    showSuccessMessage(result) {
        alert(`å…¥è·æµç¨‹å·²å•Ÿå‹•ï¼\nè¿½è¹¤ç·¨è™Ÿï¼š${result.trackingId}`);
    }

    showErrorMessage(message) {
        alert(`éŒ¯èª¤ï¼š${message}`);
    }
}

// åˆå§‹åŒ–ç³»çµ±
document.addEventListener('DOMContentLoaded', () => {
    new OnboardingManagement();
});
```

## 8.5 æœ¬ç« ç¸½çµ

æœ¬ç« æä¾›äº†ä¸‰å€‹è©³ç´°çš„ Make Bridge æ‡‰ç”¨å ´æ™¯ï¼š

âœ… **æ™ºèƒ½å®¢æœç¥¨æ“šç³»çµ±** - å®Œæ•´çš„å®¢æˆ¶æ”¯æ´è‡ªå‹•åŒ–æµç¨‹  
âœ… **é›»å•†åº«å­˜é è­¦ç³»çµ±** - æ™ºèƒ½åº«å­˜ç›£æ§å’Œè£œè²¨å»ºè­°  
âœ… **å“¡å·¥å…¥è·è‡ªå‹•åŒ–æµç¨‹** - æ–°å“¡å·¥å…¥è·çš„ç«¯åˆ°ç«¯è‡ªå‹•åŒ–  

### ğŸ“ˆ å¯¦ä½œäº®é»

æ¯å€‹å ´æ™¯éƒ½å±•ç¤ºäº†ï¼š
- **å®Œæ•´çš„æ¥­å‹™æµç¨‹è‡ªå‹•åŒ–**
- **æ™ºèƒ½è³‡æ–™åˆ†æå’Œæ±ºç­–é‚è¼¯**
- **å¤šç³»çµ±æ•´åˆå’Œä¸¦è¡Œè™•ç†**
- **ç”¨æˆ¶å‹å–„çš„ç®¡ç†ä»‹é¢**
- **å³æ™‚ç›£æ§å’Œé€šçŸ¥æ©Ÿåˆ¶**

### ğŸš€ ä¸‹ä¸€æ­¥

é€™äº›å ´æ™¯å¯ä½œç‚ºæ‚¨é–‹ç™¼è‡ªå·±çš„ Make Bridge è§£æ±ºæ–¹æ¡ˆçš„åƒè€ƒæ¨¡æ¿ã€‚æ‚¨å¯ä»¥æ ¹æ“šå…·é«”æ¥­å‹™éœ€æ±‚èª¿æ•´å·¥ä½œæµç¨‹ã€ä¿®æ”¹ä»‹é¢è¨­è¨ˆï¼Œæˆ–æ•´åˆå…¶ä»–ç³»çµ±å’Œæœå‹™ã€‚

ä¸‹ä¸€ç« å°‡æ·±å…¥æ¢è¨ Make API çš„é€²éšæ‡‰ç”¨ï¼Œç‚ºéœ€è¦æ›´é«˜åº¦å®¢è£½åŒ–çš„å ´æ™¯æä¾›æŠ€è¡“æŒ‡å°ã€‚